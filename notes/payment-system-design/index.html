<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/eb4a34bff42c1814.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-c81f7fd28659d64f.js"/><script src="/_next/static/chunks/fd9d1056-e3d373074663785d.js" async=""></script><script src="/_next/static/chunks/117-86f31d03f8df68a5.js" async=""></script><script src="/_next/static/chunks/main-app-1bdc7b9537d0c130.js" async=""></script><script src="/_next/static/chunks/972-81dbad6abe39d3fa.js" async=""></script><script src="/_next/static/chunks/832-7ea2624e20755f9f.js" async=""></script><script src="/_next/static/chunks/app/%5Bcategory%5D/%5Bslug%5D/page-e466df95e55c7602.js" async=""></script><script src="/_next/static/chunks/app/layout-3ed2f387fb22aa2c.js" async=""></script><title>支付系统设计详解 - Personal GitHub Page</title><meta name="description" content="深入分析支付系统的架构设计、核心业务流程、安全机制、对账系统等关键模块，帮助构建安全可靠的支付系统。"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"/><script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><div class="app"><header class="header "><nav class="nav-container"><a class="nav-brand" href="/"><i class="fas fa-terminal"></i>Rudy Yang</a><ul class="nav-menu"><li><a class="nav-link " href="/"><i class="fas fa-home"></i> 首页</a></li><li><a class="nav-link " href="/about/"><i class="fas fa-user"></i> 关于</a></li><li><a class="nav-link " href="/projects/"><i class="fas fa-code"></i> 项目</a></li><li><a class="nav-link " href="/notes/"><i class="fas fa-book"></i> 笔记</a></li><li><a class="nav-link " href="/articles/"><i class="fas fa-pen"></i> 随笔</a></li></ul></nav></header><main class="main-content"><div><a class="back-button" style="display:inline-block;background:var(--primary-color);color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;margin-bottom:20px;text-decoration:none" href="/notes/">← 返回<!-- -->笔记<!-- -->列表</a><article class="section"><header class="article-header"><h1 class="article-title">支付系统设计详解</h1><div class="article-meta"><div class="article-tags"><span class="tag">支付系统</span><span class="tag">系统设计</span><span class="tag">金融安全</span><span class="tag">第三方支付</span><span class="tag">对账系统</span></div></div></header><div class="card markdown-content"><div class="markdown-content"><div><h1>支付系统设计详解</h1>
<blockquote>
<p>支付系统是电商平台的核心，其安全性和可靠性直接影响整个平台的信誉</p>
</blockquote>
<h2>支付系统概述</h2>
<h3>1. 系统架构</h3>
<pre><code>支付系统架构：
┌─────────────────────────────────────────────────────────────┐
│                    前端应用层                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │   Web       │ │   Mobile    │ │   API       │           │
│  │   App       │ │   App       │ │   Client    │           │
│  └─────────────┘  └─────────────┘  └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                          │
                    ┌─────────────┐
                    │  Gateway    │
                    │  (负载均衡)  │
                    └─────────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │  Payment    │ │  Account    │ │  Risk       │
    │  Service    │ │  Service    │ │  Control    │
    └─────────────┘ └─────────────┘ └─────────────┘
          │               │               │
          └───────────────┼───────────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │  Third      │ │  Reconcile  │ │  Notify     │
    │  Party      │ │  Service    │ │  Service    │
    │  Payment    │ │             │ │             │
    └─────────────┘ └─────────────┘ └─────────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │  MySQL      │ │  Redis      │ │  MQ         │
    │  Master     │ │  Cluster    │ │  Cluster    │
    └─────────────┘ └─────────────┘ └─────────────┘
</code></pre>
<h3>2. 核心业务流程</h3>
<pre><code>支付流程：
├── 创建支付
│   ├── 验证订单
│   ├── 选择支付方式
│   ├── 生成支付单
│   └── 调用第三方支付
├── 支付处理
│   ├── 用户支付
│   ├── 支付结果回调
│   ├── 更新支付状态
│   └── 业务处理
├── 支付通知
│   ├── 异步通知
│   ├── 验证签名
│   ├── 更新订单状态
│   └── 发送通知
└── 对账处理
    ├── 获取账单
    ├── 对比账单
    ├── 处理差异
    └── 生成报告
</code></pre>
<h2>支付核心服务</h2>
<h3>1. 支付创建</h3>
<p><strong>支付服务实现</strong></p>
<pre><code class="language-java">@Service
@Transactional
public class PaymentService {
    
    @Autowired
    private PaymentRepository paymentRepository;
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private PaymentChannelService channelService;
    
    @Autowired
    private RiskControlService riskControlService;
    
    @Autowired
    private RedisTemplate&lt;String, String&gt; redisTemplate;
    
    // 创建支付
    public PaymentResponse createPayment(PaymentRequest request) {
        // 1. 验证订单
        Order order = orderService.getOrder(request.getOrderId());
        if (order == null) {
            throw new BusinessException(&quot;订单不存在&quot;);
        }
        
        // 2. 验证订单状态
        if (order.getStatus() != OrderStatus.PENDING_PAYMENT) {
            throw new BusinessException(&quot;订单状态不正确&quot;);
        }
        
        // 3. 验证支付金额
        if (!order.getPayAmount().equals(request.getAmount())) {
            throw new BusinessException(&quot;支付金额不匹配&quot;);
        }
        
        // 4. 风险控制检查
        RiskCheckResult riskResult = riskControlService.checkPaymentRisk(
            order.getUserId(), request.getAmount(), request.getIp());
        
        if (riskResult.isHighRisk()) {
            throw new BusinessException(&quot;支付风险过高&quot;);
        }
        
        // 5. 创建支付记录
        Payment payment = new Payment();
        payment.setPaymentNo(generatePaymentNo());
        payment.setOrderId(request.getOrderId());
        payment.setUserId(order.getUserId());
        payment.setAmount(request.getAmount());
        payment.setChannel(request.getChannel());
        payment.setStatus(PaymentStatus.PENDING);
        payment.setCreateTime(new Date());
        
        payment = paymentRepository.save(payment);
        
        // 6. 调用第三方支付
        PaymentChannel channel = channelService.getChannel(request.getChannel());
        ThirdPartyPaymentRequest thirdPartyRequest = buildThirdPartyRequest(payment, request);
        ThirdPartyPaymentResponse thirdPartyResponse = channel.createPayment(thirdPartyRequest);
        
        // 7. 更新支付记录
        payment.setThirdPartyPaymentNo(thirdPartyResponse.getPaymentNo());
        payment.setPayUrl(thirdPartyResponse.getPayUrl());
        payment.setQrCode(thirdPartyResponse.getQrCode());
        paymentRepository.save(payment);
        
        // 8. 返回支付信息
        PaymentResponse response = new PaymentResponse();
        response.setPaymentNo(payment.getPaymentNo());
        response.setPayUrl(payment.getPayUrl());
        response.setQrCode(payment.getQrCode());
        response.setExpireTime(thirdPartyResponse.getExpireTime());
        
        return response;
    }
    
    // 支付回调处理
    @Transactional
    public void handlePaymentCallback(String channel, PaymentCallbackRequest request) {
        // 1. 验证签名
        PaymentChannel paymentChannel = channelService.getChannel(channel);
        if (!paymentChannel.verifyCallback(request)) {
            throw new BusinessException(&quot;回调签名验证失败&quot;);
        }
        
        // 2. 查找支付记录
        Payment payment = paymentRepository.findByThirdPartyPaymentNo(
            request.getThirdPartyPaymentNo());
        
        if (payment == null) {
            throw new BusinessException(&quot;支付记录不存在&quot;);
        }
        
        // 3. 防止重复处理
        if (payment.getStatus() != PaymentStatus.PENDING) {
            return;
        }
        
        // 4. 更新支付状态
        if (request.isSuccess()) {
            payment.setStatus(PaymentStatus.SUCCESS);
            payment.setPayTime(new Date());
            payment.setThirdPartyTradeNo(request.getThirdPartyTradeNo());
            
            // 更新订单状态
            orderService.handlePaymentSuccess(payment.getOrderId());
            
            // 发送支付成功消息
            sendPaymentSuccessMessage(payment);
        } else {
            payment.setStatus(PaymentStatus.FAILED);
            payment.setFailReason(request.getFailReason());
            
            // 发送支付失败消息
            sendPaymentFailedMessage(payment);
        }
        
        payment.setUpdateTime(new Date());
        paymentRepository.save(payment);
    }
    
    // 查询支付状态
    public PaymentStatus queryPaymentStatus(String paymentNo) {
        Payment payment = getPayment(paymentNo);
        
        // 如果支付还在处理中，查询第三方状态
        if (payment.getStatus() == PaymentStatus.PENDING) {
            PaymentChannel channel = channelService.getChannel(payment.getChannel());
            ThirdPartyPaymentStatus status = channel.queryPaymentStatus(
                payment.getThirdPartyPaymentNo());
            
            if (status == ThirdPartyPaymentStatus.SUCCESS) {
                payment.setStatus(PaymentStatus.SUCCESS);
                payment.setPayTime(new Date());
                paymentRepository.save(payment);
                
                // 更新订单状态
                orderService.handlePaymentSuccess(payment.getOrderId());
            } else if (status == ThirdPartyPaymentStatus.FAILED) {
                payment.setStatus(PaymentStatus.FAILED);
                paymentRepository.save(payment);
            }
        }
        
        return payment.getStatus();
    }
    
    // 申请退款
    public RefundResponse createRefund(RefundRequest request) {
        Payment payment = getPayment(request.getPaymentNo());
        
        // 验证支付状态
        if (payment.getStatus() != PaymentStatus.SUCCESS) {
            throw new BusinessException(&quot;支付状态不正确&quot;);
        }
        
        // 验证退款金额
        if (request.getAmount().compareTo(payment.getAmount()) &gt; 0) {
            throw new BusinessException(&quot;退款金额不能大于支付金额&quot;);
        }
        
        // 创建退款记录
        Refund refund = new Refund();
        refund.setRefundNo(generateRefundNo());
        refund.setPaymentNo(payment.getPaymentNo());
        refund.setAmount(request.getAmount());
        refund.setReason(request.getReason());
        refund.setStatus(RefundStatus.PENDING);
        refund.setCreateTime(new Date());
        
        refund = refundRepository.save(refund);
        
        // 调用第三方退款
        PaymentChannel channel = channelService.getChannel(payment.getChannel());
        ThirdPartyRefundRequest thirdPartyRequest = buildThirdPartyRefundRequest(refund);
        ThirdPartyRefundResponse thirdPartyResponse = channel.createRefund(thirdPartyRequest);
        
        // 更新退款状态
        if (thirdPartyResponse.isSuccess()) {
            refund.setStatus(RefundStatus.SUCCESS);
            refund.setRefundTime(new Date());
            
            // 更新支付状态
            if (request.getAmount().equals(payment.getAmount())) {
                payment.setStatus(PaymentStatus.REFUNDED);
            } else {
                payment.setStatus(PaymentStatus.PARTIAL_REFUNDED);
            }
            paymentRepository.save(payment);
        } else {
            refund.setStatus(RefundStatus.FAILED);
            refund.setFailReason(thirdPartyResponse.getFailReason());
        }
        
        refund.setUpdateTime(new Date());
        refundRepository.save(refund);
        
        // 发送退款消息
        sendRefundMessage(refund);
        
        RefundResponse response = new RefundResponse();
        response.setRefundNo(refund.getRefundNo());
        response.setStatus(refund.getStatus());
        response.setAmount(refund.getAmount());
        
        return response;
    }
    
    private String generatePaymentNo() {
        return &quot;PAY&quot; + System.currentTimeMillis() + 
               String.format(&quot;%04d&quot;, new Random().nextInt(10000));
    }
    
    private String generateRefundNo() {
        return &quot;REF&quot; + System.currentTimeMillis() + 
               String.format(&quot;%04d&quot;, new Random().nextInt(10000));
    }
    
    private ThirdPartyPaymentRequest buildThirdPartyRequest(Payment payment, PaymentRequest request) {
        ThirdPartyPaymentRequest thirdPartyRequest = new ThirdPartyPaymentRequest();
        thirdPartyRequest.setOutTradeNo(payment.getPaymentNo());
        thirdPartyRequest.setAmount(payment.getAmount());
        thirdPartyRequest.setSubject(&quot;订单支付&quot;);
        thirdPartyRequest.setNotifyUrl(getNotifyUrl(payment.getChannel()));
        thirdPartyRequest.setReturnUrl(getReturnUrl(payment.getChannel()));
        thirdPartyRequest.setExpireTime(30); // 30分钟过期
        return thirdPartyRequest;
    }
    
    private ThirdPartyRefundRequest buildThirdPartyRefundRequest(Refund refund) {
        ThirdPartyRefundRequest request = new ThirdPartyRefundRequest();
        request.setOutRefundNo(refund.getRefundNo());
        request.setAmount(refund.getAmount());
        request.setReason(refund.getReason());
        return request;
    }
    
    private String getNotifyUrl(String channel) {
        return &quot;https://api.example.com/payment/callback/&quot; + channel;
    }
    
    private String getReturnUrl(String channel) {
        return &quot;https://www.example.com/payment/return/&quot; + channel;
    }
    
    private void sendPaymentSuccessMessage(Payment payment) {
        PaymentMessage message = new PaymentMessage();
        message.setPaymentNo(payment.getPaymentNo());
        message.setOrderId(payment.getOrderId());
        message.setUserId(payment.getUserId());
        message.setAmount(payment.getAmount());
        message.setAction(&quot;PAYMENT_SUCCESS&quot;);
        
        rabbitTemplate.convertAndSend(&quot;payment.exchange&quot;, &quot;payment.success&quot;, message);
    }
    
    private void sendPaymentFailedMessage(Payment payment) {
        PaymentMessage message = new PaymentMessage();
        message.setPaymentNo(payment.getPaymentNo());
        message.setOrderId(payment.getOrderId());
        message.setUserId(payment.getUserId());
        message.setAmount(payment.getAmount());
        message.setAction(&quot;PAYMENT_FAILED&quot;);
        
        rabbitTemplate.convertAndSend(&quot;payment.exchange&quot;, &quot;payment.failed&quot;, message);
    }
    
    private void sendRefundMessage(Refund refund) {
        PaymentMessage message = new PaymentMessage();
        message.setRefundNo(refund.getRefundNo());
        message.setPaymentNo(refund.getPaymentNo());
        message.setAmount(refund.getAmount());
        message.setAction(&quot;REFUND&quot;);
        
        rabbitTemplate.convertAndSend(&quot;payment.exchange&quot;, &quot;refund.created&quot;, message);
    }
    
    private Payment getPayment(String paymentNo) {
        return paymentRepository.findByPaymentNo(paymentNo)
            .orElseThrow(() -&gt; new BusinessException(&quot;支付记录不存在&quot;));
    }
}
</code></pre>
<h3>2. 支付渠道管理</h3>
<p><strong>支付渠道服务</strong></p>
<pre><code class="language-java">@Service
public class PaymentChannelService {
    
    @Autowired
    private Map&lt;String, PaymentChannel&gt; channelMap;
    
    @PostConstruct
    public void initChannels() {
        channelMap.put(&quot;ALIPAY&quot;, new AlipayChannel());
        channelMap.put(&quot;WECHAT&quot;, new WechatChannel());
        channelMap.put(&quot;UNIONPAY&quot;, new UnionpayChannel());
    }
    
    public PaymentChannel getChannel(String channel) {
        PaymentChannel paymentChannel = channelMap.get(channel.toUpperCase());
        if (paymentChannel == null) {
            throw new BusinessException(&quot;不支持的支付渠道&quot;);
        }
        return paymentChannel;
    }
    
    public List&lt;PaymentChannel&gt; getAvailableChannels() {
        return new ArrayList&lt;&gt;(channelMap.values());
    }
}

// 支付渠道接口
public interface PaymentChannel {
    
    ThirdPartyPaymentResponse createPayment(ThirdPartyPaymentRequest request);
    
    ThirdPartyPaymentStatus queryPaymentStatus(String thirdPartyPaymentNo);
    
    ThirdPartyRefundResponse createRefund(ThirdPartyRefundRequest request);
    
    boolean verifyCallback(PaymentCallbackRequest request);
}

// 支付宝渠道实现
@Component
public class AlipayChannel implements PaymentChannel {
    
    @Value(&quot;${alipay.app.id}&quot;)
    private String appId;
    
    @Value(&quot;${alipay.private.key}&quot;)
    private String privateKey;
    
    @Value(&quot;${alipay.public.key}&quot;)
    private String publicKey;
    
    @Override
    public ThirdPartyPaymentResponse createPayment(ThirdPartyPaymentRequest request) {
        try {
            AlipayClient alipayClient = new DefaultAlipayClient(
                &quot;https://openapi.alipay.com/gateway.do&quot;,
                appId,
                privateKey,
                &quot;json&quot;,
                &quot;UTF-8&quot;,
                publicKey,
                &quot;RSA2&quot;
            );
            
            AlipayTradePagePayRequest alipayRequest = new AlipayTradePagePayRequest();
            alipayRequest.setReturnUrl(request.getReturnUrl());
            alipayRequest.setNotifyUrl(request.getNotifyUrl());
            
            alipayRequest.setBizContent(String.format(
                &quot;{\&quot;out_trade_no\&quot;:\&quot;%s\&quot;,\&quot;total_amount\&quot;:\&quot;%s\&quot;,\&quot;subject\&quot;:\&quot;%s\&quot;}&quot;,
                request.getOutTradeNo(),
                request.getAmount(),
                request.getSubject()
            ));
            
            AlipayTradePagePayResponse response = alipayClient.pageExecute(alipayRequest);
            
            ThirdPartyPaymentResponse result = new ThirdPartyPaymentResponse();
            result.setSuccess(response.isSuccess());
            result.setPaymentNo(response.getOutTradeNo());
            result.setPayUrl(response.getBody());
            
            return result;
        } catch (AlipayApiException e) {
            throw new BusinessException(&quot;支付宝支付失败&quot;);
        }
    }
    
    @Override
    public ThirdPartyPaymentStatus queryPaymentStatus(String thirdPartyPaymentNo) {
        try {
            AlipayClient alipayClient = new DefaultAlipayClient(
                &quot;https://openapi.alipay.com/gateway.do&quot;,
                appId,
                privateKey,
                &quot;json&quot;,
                &quot;UTF-8&quot;,
                publicKey,
                &quot;RSA2&quot;
            );
            
            AlipayTradeQueryRequest request = new AlipayTradeQueryRequest();
            request.setBizContent(String.format(
                &quot;{\&quot;out_trade_no\&quot;:\&quot;%s\&quot;}&quot;,
                thirdPartyPaymentNo
            ));
            
            AlipayTradeQueryResponse response = alipayClient.execute(request);
            
            if (response.isSuccess()) {
                if (&quot;TRADE_SUCCESS&quot;.equals(response.getTradeStatus()) || 
                    &quot;TRADE_FINISHED&quot;.equals(response.getTradeStatus())) {
                    return ThirdPartyPaymentStatus.SUCCESS;
                } else if (&quot;WAIT_BUYER_PAY&quot;.equals(response.getTradeStatus())) {
                    return ThirdPartyPaymentStatus.PENDING;
                } else {
                    return ThirdPartyPaymentStatus.FAILED;
                }
            } else {
                return ThirdPartyPaymentStatus.FAILED;
            }
        } catch (AlipayApiException e) {
            throw new BusinessException(&quot;查询支付状态失败&quot;);
        }
    }
    
    @Override
    public ThirdPartyRefundResponse createRefund(ThirdPartyRefundRequest request) {
        try {
            AlipayClient alipayClient = new DefaultAlipayClient(
                &quot;https://openapi.alipay.com/gateway.do&quot;,
                appId,
                privateKey,
                &quot;json&quot;,
                &quot;UTF-8&quot;,
                publicKey,
                &quot;RSA2&quot;
            );
            
            AlipayTradeRefundRequest alipayRequest = new AlipayTradeRefundRequest();
            alipayRequest.setBizContent(String.format(
                &quot;{\&quot;out_trade_no\&quot;:\&quot;%s\&quot;,\&quot;refund_amount\&quot;:\&quot;%s\&quot;,\&quot;refund_reason\&quot;:\&quot;%s\&quot;}&quot;,
                request.getOutRefundNo(),
                request.getAmount(),
                request.getReason()
            ));
            
            AlipayTradeRefundResponse response = alipayClient.execute(alipayRequest);
            
            ThirdPartyRefundResponse result = new ThirdPartyRefundResponse();
            result.setSuccess(response.isSuccess());
            result.setRefundNo(response.getOutTradeNo());
            
            return result;
        } catch (AlipayApiException e) {
            throw new BusinessException(&quot;支付宝退款失败&quot;);
        }
    }
    
    @Override
    public boolean verifyCallback(PaymentCallbackRequest request) {
        try {
            Map&lt;String, String&gt; params = request.getParams();
            
            // 验证签名
            return AlipaySignature.rsaCheckV1(
                params,
                publicKey,
                &quot;UTF-8&quot;,
                &quot;RSA2&quot;
            );
        } catch (AlipayApiException e) {
            return false;
        }
    }
}
</code></pre>
<h2>风险控制</h2>
<h3>1. 风险评估</h3>
<p><strong>风险控制服务</strong></p>
<pre><code class="language-java">@Service
public class RiskControlService {
    
    @Autowired
    private RiskRuleRepository riskRuleRepository;
    
    @Autowired
    private RedisTemplate&lt;String, String&gt; redisTemplate;
    
    // 支付风险检查
    public RiskCheckResult checkPaymentRisk(Long userId, BigDecimal amount, String ip) {
        RiskCheckResult result = new RiskCheckResult();
        
        // 1. 用户风险检查
        int userRiskScore = checkUserRisk(userId);
        
        // 2. 金额风险检查
        int amountRiskScore = checkAmountRisk(userId, amount);
        
        // 3. IP风险检查
        int ipRiskScore = checkIpRisk(ip);
        
        // 4. 频率风险检查
        int frequencyRiskScore = checkFrequencyRisk(userId);
        
        // 5. 设备风险检查
        int deviceRiskScore = checkDeviceRisk(userId, request.getDeviceId());
        
        // 计算总风险分数
        int totalRiskScore = userRiskScore + amountRiskScore + ipRiskScore + 
                           frequencyRiskScore + deviceRiskScore;
        
        result.setRiskScore(totalRiskScore);
        result.setHighRisk(totalRiskScore &gt; 80);
        
        // 记录风险检查日志
        recordRiskCheck(userId, amount, ip, totalRiskScore);
        
        return result;
    }
    
    // 用户风险检查
    private int checkUserRisk(Long userId) {
        UserRiskProfile profile = getUserRiskProfile(userId);
        
        int riskScore = 0;
        
        // 检查用户注册时间
        if (profile.getRegisterTime().after(DateUtils.addDays(new Date(), -7))) {
            riskScore += 20;
        }
        
        // 检查用户认证状态
        if (!profile.isRealNameVerified()) {
            riskScore += 15;
        }
        
        // 检查用户历史风险记录
        if (profile.getRiskCount() &gt; 0) {
            riskScore += 10 * profile.getRiskCount();
        }
        
        // 检查用户支付频率
        if (profile.getPaymentCount() &gt; 100) {
            riskScore += 5;
        }
        
        return riskScore;
    }
    
    // 金额风险检查
    private int checkAmountRisk(Long userId, BigDecimal amount) {
        int riskScore = 0;
        
        // 获取用户历史支付金额
        BigDecimal avgAmount = getUserAveragePaymentAmount(userId);
        
        // 检查支付金额是否异常
        if (amount.compareTo(avgAmount.multiply(new BigDecimal(&quot;5&quot;))) &gt; 0) {
            riskScore += 25;
        } else if (amount.compareTo(avgAmount.multiply(new BigDecimal(&quot;3&quot;))) &gt; 0) {
            riskScore += 15;
        }
        
        // 检查大额支付
        if (amount.compareTo(new BigDecimal(&quot;10000&quot;)) &gt; 0) {
            riskScore += 20;
        }
        
        return riskScore;
    }
    
    // IP风险检查
    private int checkIpRisk(String ip) {
        int riskScore = 0;
        
        // 检查IP是否在黑名单中
        if (isIpInBlacklist(ip)) {
            riskScore += 50;
        }
        
        // 检查IP地理位置
        String location = getIpLocation(ip);
        if (isHighRiskLocation(location)) {
            riskScore += 20;
        }
        
        // 检查IP代理
        if (isProxyIp(ip)) {
            riskScore += 30;
        }
        
        return riskScore;
    }
    
    // 频率风险检查
    private int checkFrequencyRisk(Long userId) {
        int riskScore = 0;
        
        // 检查最近1小时内的支付次数
        int hourCount = getPaymentCount(userId, 1);
        if (hourCount &gt; 10) {
            riskScore += 20;
        }
        
        // 检查最近24小时内的支付次数
        int dayCount = getPaymentCount(userId, 24);
        if (dayCount &gt; 50) {
            riskScore += 15;
        }
        
        return riskScore;
    }
    
    // 设备风险检查
    private int checkDeviceRisk(Long userId, String deviceId) {
        int riskScore = 0;
        
        // 检查设备是否为新设备
        if (!isKnownDevice(userId, deviceId)) {
            riskScore += 10;
        }
        
        // 检查设备风险等级
        int deviceRiskLevel = getDeviceRiskLevel(deviceId);
        riskScore += deviceRiskLevel * 5;
        
        return riskScore;
    }
    
    // 记录风险检查日志
    private void recordRiskCheck(Long userId, BigDecimal amount, String ip, int riskScore) {
        RiskCheckLog log = new RiskCheckLog();
        log.setUserId(userId);
        log.setAmount(amount);
        log.setIp(ip);
        log.setRiskScore(riskScore);
        log.setCheckTime(new Date());
        
        riskCheckLogRepository.save(log);
        
        // 如果风险分数过高，发送告警
        if (riskScore &gt; 80) {
            sendRiskAlert(userId, amount, ip, riskScore);
        }
    }
    
    private void sendRiskAlert(Long userId, BigDecimal amount, String ip, int riskScore) {
        RiskAlert alert = new RiskAlert();
        alert.setUserId(userId);
        alert.setAmount(amount);
        alert.setIp(ip);
        alert.setRiskScore(riskScore);
        alert.setAlertTime(new Date());
        
        // 发送告警通知
        notificationService.sendRiskAlert(alert);
    }
    
    private UserRiskProfile getUserRiskProfile(Long userId) {
        // 从数据库获取用户风险档案
        return userRiskProfileRepository.findByUserId(userId);
    }
    
    private BigDecimal getUserAveragePaymentAmount(Long userId) {
        // 计算用户平均支付金额
        return paymentRepository.calculateAverageAmountByUserId(userId);
    }
    
    private boolean isIpInBlacklist(String ip) {
        String key = &quot;risk:ip:blacklist&quot;;
        return redisTemplate.opsForSet().isMember(key, ip);
    }
    
    private String getIpLocation(String ip) {
        // 调用IP地理位置服务
        return ipLocationService.getLocation(ip);
    }
    
    private boolean isHighRiskLocation(String location) {
        List&lt;String&gt; highRiskLocations = Arrays.asList(&quot;XX&quot;, &quot;YY&quot;, &quot;ZZ&quot;);
        return highRiskLocations.contains(location);
    }
    
    private boolean isProxyIp(String ip) {
        // 检查是否为代理IP
        return ipDetectionService.isProxyIp(ip);
    }
    
    private int getPaymentCount(Long userId, int hours) {
        // 获取指定小时内的支付次数
        return paymentRepository.countByUserIdAndTimeRange(userId, hours);
    }
    
    private boolean isKnownDevice(Long userId, String deviceId) {
        String key = &quot;user:device:&quot; + userId;
        return redisTemplate.opsForSet().isMember(key, deviceId);
    }
    
    private int getDeviceRiskLevel(String deviceId) {
        // 获取设备风险等级
        return deviceRiskService.getRiskLevel(deviceId);
    }
}
</code></pre>
<h2>对账系统</h2>
<h3>1. 对账服务</h3>
<p><strong>对账服务实现</strong></p>
<pre><code class="language-java">@Service
public class ReconciliationService {
    
    @Autowired
    private ReconciliationRepository reconciliationRepository;
    
    @Autowired
    private PaymentRepository paymentRepository;
    
    @Scheduled(cron = &quot;0 0 2 * * ?&quot;) // 每天凌晨2点执行
    public void dailyReconciliation() {
        String yesterday = DateUtils.formatDate(DateUtils.addDays(new Date(), -1));
        
        // 1. 获取内部账单
        List&lt;InternalBill&gt; internalBills = getInternalBills(yesterday);
        
        // 2. 获取第三方账单
        List&lt;ThirdPartyBill&gt; thirdPartyBills = getThirdPartyBills(yesterday);
        
        // 3. 执行对账
        ReconciliationResult result = reconcile(internalBills, thirdPartyBills);
        
        // 4. 保存对账结果
        saveReconciliationResult(yesterday, result);
        
        // 5. 处理差异
        if (result.hasDiscrepancy()) {
            handleDiscrepancies(result.getDiscrepancies());
        }
    }
    
    // 获取内部账单
    private List&lt;InternalBill&gt; getInternalBills(String date) {
        return paymentRepository.findByDate(date)
            .stream()
            .map(this::convertToInternalBill)
            .collect(Collectors.toList());
    }
    
    // 获取第三方账单
    private List&lt;ThirdPartyBill&gt; getThirdPartyBills(String date) {
        List&lt;ThirdPartyBill&gt; bills = new ArrayList&lt;&gt;();
        
        // 获取支付宝账单
        bills.addAll(getAlipayBills(date));
        
        // 获取微信账单
        bills.addAll(getWechatBills(date));
        
        // 获取银联账单
        bills.addAll(getUnionpayBills(date));
        
        return bills;
    }
    
    // 执行对账
    private ReconciliationResult reconcile(List&lt;InternalBill&gt; internalBills, 
                                         List&lt;ThirdPartyBill&gt; thirdPartyBills) {
        ReconciliationResult result = new ReconciliationResult();
        
        // 按支付单号分组
        Map&lt;String, InternalBill&gt; internalBillMap = internalBills.stream()
            .collect(Collectors.toMap(InternalBill::getPaymentNo, Function.identity()));
        
        Map&lt;String, ThirdPartyBill&gt; thirdPartyBillMap = thirdPartyBills.stream()
            .collect(Collectors.toMap(ThirdPartyBill::getPaymentNo, Function.identity()));
        
        // 检查内部账单在第三方账单中是否存在
        for (InternalBill internalBill : internalBills) {
            ThirdPartyBill thirdPartyBill = thirdPartyBillMap.get(internalBill.getPaymentNo());
            
            if (thirdPartyBill == null) {
                // 第三方账单缺失
                result.addDiscrepancy(new Discrepancy(
                    internalBill.getPaymentNo(),
                    DiscrepancyType.THIRD_PARTY_MISSING,
                    internalBill.getAmount(),
                    BigDecimal.ZERO
                ));
            } else {
                // 检查金额是否一致
                if (!internalBill.getAmount().equals(thirdPartyBill.getAmount())) {
                    result.addDiscrepancy(new Discrepancy(
                        internalBill.getPaymentNo(),
                        DiscrepancyType.AMOUNT_MISMATCH,
                        internalBill.getAmount(),
                        thirdPartyBill.getAmount()
                    ));
                }
                
                // 检查状态是否一致
                if (!internalBill.getStatus().equals(thirdPartyBill.getStatus())) {
                    result.addDiscrepancy(new Discrepancy(
                        internalBill.getPaymentNo(),
                        DiscrepancyType.STATUS_MISMATCH,
                        internalBill.getStatus(),
                        thirdPartyBill.getStatus()
                    ));
                }
                
                // 从第三方账单中移除已匹配的账单
                thirdPartyBillMap.remove(internalBill.getPaymentNo());
            }
        }
        
        // 检查第三方账单中多余的账单
        for (ThirdPartyBill thirdPartyBill : thirdPartyBillMap.values()) {
            result.addDiscrepancy(new Discrepancy(
                thirdPartyBill.getPaymentNo(),
                DiscrepancyType.INTERNAL_MISSING,
                BigDecimal.ZERO,
                thirdPartyBill.getAmount()
            ));
        }
        
        return result;
    }
    
    // 处理差异
    private void handleDiscrepancies(List&lt;Discrepancy&gt; discrepancies) {
        for (Discrepancy discrepancy : discrepancies) {
            switch (discrepancy.getType()) {
                case THIRD_PARTY_MISSING:
                    handleThirdPartyMissing(discrepancy);
                    break;
                case INTERNAL_MISSING:
                    handleInternalMissing(discrepancy);
                    break;
                case AMMOUNT_MISMATCH:
                    handleAmountMismatch(discrepancy);
                    break;
                case STATUS_MISMATCH:
                    handleStatusMismatch(discrepancy);
                    break;
            }
        }
    }
    
    // 处理第三方账单缺失
    private void handleThirdPartyMissing(Discrepancy discrepancy) {
        // 查询第三方支付状态
        Payment payment = paymentRepository.findByPaymentNo(discrepancy.getPaymentNo());
        
        PaymentChannel channel = channelService.getChannel(payment.getChannel());
        ThirdPartyPaymentStatus status = channel.queryPaymentStatus(
            payment.getThirdPartyPaymentNo());
        
        if (status == ThirdPartyPaymentStatus.SUCCESS) {
            // 更新支付状态
            payment.setStatus(PaymentStatus.SUCCESS);
            payment.setPayTime(new Date());
            paymentRepository.save(payment);
            
            // 更新订单状态
            orderService.handlePaymentSuccess(payment.getOrderId());
        } else if (status == ThirdPartyPaymentStatus.FAILED) {
            // 更新支付状态
            payment.setStatus(PaymentStatus.FAILED);
            paymentRepository.save(payment);
        }
    }
    
    // 处理内部账单缺失
    private void handleInternalMissing(Discrepancy discrepancy) {
        // 创建缺失的内部账单
        Payment payment = new Payment();
        payment.setPaymentNo(discrepancy.getPaymentNo());
        payment.setAmount(discrepancy.getThirdPartyAmount());
        payment.setStatus(PaymentStatus.SUCCESS);
        payment.setCreateTime(new Date());
        
        paymentRepository.save(payment);
        
        // 记录异常
        recordReconciliationException(discrepancy, &quot;内部账单缺失&quot;);
    }
    
    // 处理金额不匹配
    private void handleAmountMismatch(Discrepancy discrepancy) {
        // 记录异常
        recordReconciliationException(discrepancy, &quot;金额不匹配&quot;);
        
        // 发送告警
        sendReconciliationAlert(discrepancy);
    }
    
    // 处理状态不匹配
    private void handleStatusMismatch(Discrepancy discrepancy) {
        // 更新内部状态
        Payment payment = paymentRepository.findByPaymentNo(discrepancy.getPaymentNo());
        payment.setStatus(PaymentStatus.SUCCESS);
        payment.setPayTime(new Date());
        paymentRepository.save(payment);
        
        // 更新订单状态
        orderService.handlePaymentSuccess(payment.getOrderId());
    }
    
    // 记录对账异常
    private void recordReconciliationException(Discrepancy discrepancy, String reason) {
        ReconciliationException exception = new ReconciliationException();
        exception.setPaymentNo(discrepancy.getPaymentNo());
        exception.setReason(reason);
        exception.setInternalAmount(discrepancy.getInternalAmount());
        exception.setThirdPartyAmount(discrepancy.getThirdPartyAmount());
        exception.setCreateTime(new Date());
        
        reconciliationExceptionRepository.save(exception);
    }
    
    // 发送对账告警
    private void sendReconciliationAlert(Discrepancy discrepancy) {
        ReconciliationAlert alert = new ReconciliationAlert();
        alert.setPaymentNo(discrepancy.getPaymentNo());
        alert.setType(discrepancy.getType());
        alert.setInternalAmount(discrepancy.getInternalAmount());
        alert.setThirdPartyAmount(discrepancy.getThirdPartyAmount());
        alert.setAlertTime(new Date());
        
        notificationService.sendReconciliationAlert(alert);
    }
    
    private InternalBill convertToInternalBill(Payment payment) {
        InternalBill bill = new InternalBill();
        bill.setPaymentNo(payment.getPaymentNo());
        bill.setAmount(payment.getAmount());
        bill.setStatus(payment.getStatus());
        bill.setPayTime(payment.getPayTime());
        return bill;
    }
    
    private List&lt;ThirdPartyBill&gt; getAlipayBills(String date) {
        // 调用支付宝账单接口
        return alipayService.getBills(date);
    }
    
    private List&lt;ThirdPartyBill&gt; getWechatBills(String date) {
        // 调用微信账单接口
        return wechatService.getBills(date);
    }
    
    private List&lt;ThirdPartyBill&gt; getUnionpayBills(String date) {
        // 调用银联账单接口
        return unionpayService.getBills(date);
    }
}
</code></pre>
<h2>总结</h2>
<p>支付系统设计需要考虑以下关键点：</p>
<ol>
<li><strong>安全性</strong>：确保支付过程的安全可靠</li>
<li><strong>一致性</strong>：保证支付状态与业务状态的一致性</li>
<li><strong>可靠性</strong>：确保支付流程的稳定运行</li>
<li><strong>扩展性</strong>：支持多种支付渠道的接入</li>
<li><strong>监控性</strong>：完善的监控和对账机制</li>
</ol>
<p>通过合理的架构设计和严格的流程控制，可以构建安全、可靠的支付系统。</p>
</div></div></div></article></div></main></div><script src="/_next/static/chunks/webpack-c81f7fd28659d64f.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/eb4a34bff42c1814.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"2:I[2846,[],\"\"]\n5:I[4707,[],\"\"]\n8:I[6423,[],\"\"]\nb:I[1060,[],\"\"]\n6:[\"category\",\"notes\",\"d\"]\n7:[\"slug\",\"payment-system-design\",\"d\"]\nc:[]\n0:[\"$\",\"$L2\",null,{\"buildId\":\"build\",\"assetPrefix\":\"\",\"urlParts\":[\"\",\"notes\",\"payment-system-design\",\"\"],\"initialTree\":[\"\",{\"children\":[[\"category\",\"notes\",\"d\"],{\"children\":[[\"slug\",\"payment-system-design\",\"d\"],{\"children\":[\"__PAGE__?{\\\"category\\\":\\\"notes\\\",\\\"slug\\\":\\\"payment-system-design\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[[\"category\",\"notes\",\"d\"],{\"children\":[[\"slug\",\"payment-system-design\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$L3\",\"$L4\",null],null],null]},[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"$6\",\"children\",\"$7\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"$6\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/eb4a34bff42c1814.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],\"$L9\"],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$La\"],\"globalErrorComponent\":\"$b\",\"missingSlots\":\"$Wc\"}]\n"])</script><script>self.__next_f.push([1,"d:I[2972,[\"972\",\"static/chunks/972-81dbad6abe39d3fa.js\",\"832\",\"static/chunks/832-7ea2624e20755f9f.js\",\"621\",\"static/chunks/app/%5Bcategory%5D/%5Bslug%5D/page-e466df95e55c7602.js\"],\"\"]\ne:I[2024,[\"972\",\"static/chunks/972-81dbad6abe39d3fa.js\",\"832\",\"static/chunks/832-7ea2624e20755f9f.js\",\"621\",\"static/chunks/app/%5Bcategory%5D/%5Bslug%5D/page-e466df95e55c7602.js\"],\"default\"]\n10:I[7140,[\"972\",\"static/chunks/972-81dbad6abe39d3fa.js\",\"185\",\"static/chunks/app/layout-3ed2f387fb22aa2c.js\"],\"default\"]\nf:T93d7,"])</script><script>self.__next_f.push([1,"\n# 支付系统设计详解\n\n\u003e 支付系统是电商平台的核心，其安全性和可靠性直接影响整个平台的信誉\n\n## 支付系统概述\n\n### 1. 系统架构\n\n```\n支付系统架构：\n┌─────────────────────────────────────────────────────────────┐\n│                    前端应用层                               │\n│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │\n│  │   Web       │ │   Mobile    │ │   API       │           │\n│  │   App       │ │   App       │ │   Client    │           │\n│  └─────────────┘  └─────────────┘  └─────────────┘           │\n└─────────────────────────────────────────────────────────────┘\n                          │\n                    ┌─────────────┐\n                    │  Gateway    │\n                    │  (负载均衡)  │\n                    └─────────────┘\n                          │\n          ┌───────────────┼───────────────┐\n          │               │               │\n    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐\n    │  Payment    │ │  Account    │ │  Risk       │\n    │  Service    │ │  Service    │ │  Control    │\n    └─────────────┘ └─────────────┘ └─────────────┘\n          │               │               │\n          └───────────────┼───────────────┘\n                          │\n          ┌───────────────┼───────────────┐\n          │               │               │\n    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐\n    │  Third      │ │  Reconcile  │ │  Notify     │\n    │  Party      │ │  Service    │ │  Service    │\n    │  Payment    │ │             │ │             │\n    └─────────────┘ └─────────────┘ └─────────────┘\n                          │\n          ┌───────────────┼───────────────┐\n          │               │               │\n    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐\n    │  MySQL      │ │  Redis      │ │  MQ         │\n    │  Master     │ │  Cluster    │ │  Cluster    │\n    └─────────────┘ └─────────────┘ └─────────────┘\n```\n\n### 2. 核心业务流程\n\n```\n支付流程：\n├── 创建支付\n│   ├── 验证订单\n│   ├── 选择支付方式\n│   ├── 生成支付单\n│   └── 调用第三方支付\n├── 支付处理\n│   ├── 用户支付\n│   ├── 支付结果回调\n│   ├── 更新支付状态\n│   └── 业务处理\n├── 支付通知\n│   ├── 异步通知\n│   ├── 验证签名\n│   ├── 更新订单状态\n│   └── 发送通知\n└── 对账处理\n    ├── 获取账单\n    ├── 对比账单\n    ├── 处理差异\n    └── 生成报告\n```\n\n## 支付核心服务\n\n### 1. 支付创建\n\n**支付服务实现**\n```java\n@Service\n@Transactional\npublic class PaymentService {\n    \n    @Autowired\n    private PaymentRepository paymentRepository;\n    \n    @Autowired\n    private OrderService orderService;\n    \n    @Autowired\n    private PaymentChannelService channelService;\n    \n    @Autowired\n    private RiskControlService riskControlService;\n    \n    @Autowired\n    private RedisTemplate\u003cString, String\u003e redisTemplate;\n    \n    // 创建支付\n    public PaymentResponse createPayment(PaymentRequest request) {\n        // 1. 验证订单\n        Order order = orderService.getOrder(request.getOrderId());\n        if (order == null) {\n            throw new BusinessException(\"订单不存在\");\n        }\n        \n        // 2. 验证订单状态\n        if (order.getStatus() != OrderStatus.PENDING_PAYMENT) {\n            throw new BusinessException(\"订单状态不正确\");\n        }\n        \n        // 3. 验证支付金额\n        if (!order.getPayAmount().equals(request.getAmount())) {\n            throw new BusinessException(\"支付金额不匹配\");\n        }\n        \n        // 4. 风险控制检查\n        RiskCheckResult riskResult = riskControlService.checkPaymentRisk(\n            order.getUserId(), request.getAmount(), request.getIp());\n        \n        if (riskResult.isHighRisk()) {\n            throw new BusinessException(\"支付风险过高\");\n        }\n        \n        // 5. 创建支付记录\n        Payment payment = new Payment();\n        payment.setPaymentNo(generatePaymentNo());\n        payment.setOrderId(request.getOrderId());\n        payment.setUserId(order.getUserId());\n        payment.setAmount(request.getAmount());\n        payment.setChannel(request.getChannel());\n        payment.setStatus(PaymentStatus.PENDING);\n        payment.setCreateTime(new Date());\n        \n        payment = paymentRepository.save(payment);\n        \n        // 6. 调用第三方支付\n        PaymentChannel channel = channelService.getChannel(request.getChannel());\n        ThirdPartyPaymentRequest thirdPartyRequest = buildThirdPartyRequest(payment, request);\n        ThirdPartyPaymentResponse thirdPartyResponse = channel.createPayment(thirdPartyRequest);\n        \n        // 7. 更新支付记录\n        payment.setThirdPartyPaymentNo(thirdPartyResponse.getPaymentNo());\n        payment.setPayUrl(thirdPartyResponse.getPayUrl());\n        payment.setQrCode(thirdPartyResponse.getQrCode());\n        paymentRepository.save(payment);\n        \n        // 8. 返回支付信息\n        PaymentResponse response = new PaymentResponse();\n        response.setPaymentNo(payment.getPaymentNo());\n        response.setPayUrl(payment.getPayUrl());\n        response.setQrCode(payment.getQrCode());\n        response.setExpireTime(thirdPartyResponse.getExpireTime());\n        \n        return response;\n    }\n    \n    // 支付回调处理\n    @Transactional\n    public void handlePaymentCallback(String channel, PaymentCallbackRequest request) {\n        // 1. 验证签名\n        PaymentChannel paymentChannel = channelService.getChannel(channel);\n        if (!paymentChannel.verifyCallback(request)) {\n            throw new BusinessException(\"回调签名验证失败\");\n        }\n        \n        // 2. 查找支付记录\n        Payment payment = paymentRepository.findByThirdPartyPaymentNo(\n            request.getThirdPartyPaymentNo());\n        \n        if (payment == null) {\n            throw new BusinessException(\"支付记录不存在\");\n        }\n        \n        // 3. 防止重复处理\n        if (payment.getStatus() != PaymentStatus.PENDING) {\n            return;\n        }\n        \n        // 4. 更新支付状态\n        if (request.isSuccess()) {\n            payment.setStatus(PaymentStatus.SUCCESS);\n            payment.setPayTime(new Date());\n            payment.setThirdPartyTradeNo(request.getThirdPartyTradeNo());\n            \n            // 更新订单状态\n            orderService.handlePaymentSuccess(payment.getOrderId());\n            \n            // 发送支付成功消息\n            sendPaymentSuccessMessage(payment);\n        } else {\n            payment.setStatus(PaymentStatus.FAILED);\n            payment.setFailReason(request.getFailReason());\n            \n            // 发送支付失败消息\n            sendPaymentFailedMessage(payment);\n        }\n        \n        payment.setUpdateTime(new Date());\n        paymentRepository.save(payment);\n    }\n    \n    // 查询支付状态\n    public PaymentStatus queryPaymentStatus(String paymentNo) {\n        Payment payment = getPayment(paymentNo);\n        \n        // 如果支付还在处理中，查询第三方状态\n        if (payment.getStatus() == PaymentStatus.PENDING) {\n            PaymentChannel channel = channelService.getChannel(payment.getChannel());\n            ThirdPartyPaymentStatus status = channel.queryPaymentStatus(\n                payment.getThirdPartyPaymentNo());\n            \n            if (status == ThirdPartyPaymentStatus.SUCCESS) {\n                payment.setStatus(PaymentStatus.SUCCESS);\n                payment.setPayTime(new Date());\n                paymentRepository.save(payment);\n                \n                // 更新订单状态\n                orderService.handlePaymentSuccess(payment.getOrderId());\n            } else if (status == ThirdPartyPaymentStatus.FAILED) {\n                payment.setStatus(PaymentStatus.FAILED);\n                paymentRepository.save(payment);\n            }\n        }\n        \n        return payment.getStatus();\n    }\n    \n    // 申请退款\n    public RefundResponse createRefund(RefundRequest request) {\n        Payment payment = getPayment(request.getPaymentNo());\n        \n        // 验证支付状态\n        if (payment.getStatus() != PaymentStatus.SUCCESS) {\n            throw new BusinessException(\"支付状态不正确\");\n        }\n        \n        // 验证退款金额\n        if (request.getAmount().compareTo(payment.getAmount()) \u003e 0) {\n            throw new BusinessException(\"退款金额不能大于支付金额\");\n        }\n        \n        // 创建退款记录\n        Refund refund = new Refund();\n        refund.setRefundNo(generateRefundNo());\n        refund.setPaymentNo(payment.getPaymentNo());\n        refund.setAmount(request.getAmount());\n        refund.setReason(request.getReason());\n        refund.setStatus(RefundStatus.PENDING);\n        refund.setCreateTime(new Date());\n        \n        refund = refundRepository.save(refund);\n        \n        // 调用第三方退款\n        PaymentChannel channel = channelService.getChannel(payment.getChannel());\n        ThirdPartyRefundRequest thirdPartyRequest = buildThirdPartyRefundRequest(refund);\n        ThirdPartyRefundResponse thirdPartyResponse = channel.createRefund(thirdPartyRequest);\n        \n        // 更新退款状态\n        if (thirdPartyResponse.isSuccess()) {\n            refund.setStatus(RefundStatus.SUCCESS);\n            refund.setRefundTime(new Date());\n            \n            // 更新支付状态\n            if (request.getAmount().equals(payment.getAmount())) {\n                payment.setStatus(PaymentStatus.REFUNDED);\n            } else {\n                payment.setStatus(PaymentStatus.PARTIAL_REFUNDED);\n            }\n            paymentRepository.save(payment);\n        } else {\n            refund.setStatus(RefundStatus.FAILED);\n            refund.setFailReason(thirdPartyResponse.getFailReason());\n        }\n        \n        refund.setUpdateTime(new Date());\n        refundRepository.save(refund);\n        \n        // 发送退款消息\n        sendRefundMessage(refund);\n        \n        RefundResponse response = new RefundResponse();\n        response.setRefundNo(refund.getRefundNo());\n        response.setStatus(refund.getStatus());\n        response.setAmount(refund.getAmount());\n        \n        return response;\n    }\n    \n    private String generatePaymentNo() {\n        return \"PAY\" + System.currentTimeMillis() + \n               String.format(\"%04d\", new Random().nextInt(10000));\n    }\n    \n    private String generateRefundNo() {\n        return \"REF\" + System.currentTimeMillis() + \n               String.format(\"%04d\", new Random().nextInt(10000));\n    }\n    \n    private ThirdPartyPaymentRequest buildThirdPartyRequest(Payment payment, PaymentRequest request) {\n        ThirdPartyPaymentRequest thirdPartyRequest = new ThirdPartyPaymentRequest();\n        thirdPartyRequest.setOutTradeNo(payment.getPaymentNo());\n        thirdPartyRequest.setAmount(payment.getAmount());\n        thirdPartyRequest.setSubject(\"订单支付\");\n        thirdPartyRequest.setNotifyUrl(getNotifyUrl(payment.getChannel()));\n        thirdPartyRequest.setReturnUrl(getReturnUrl(payment.getChannel()));\n        thirdPartyRequest.setExpireTime(30); // 30分钟过期\n        return thirdPartyRequest;\n    }\n    \n    private ThirdPartyRefundRequest buildThirdPartyRefundRequest(Refund refund) {\n        ThirdPartyRefundRequest request = new ThirdPartyRefundRequest();\n        request.setOutRefundNo(refund.getRefundNo());\n        request.setAmount(refund.getAmount());\n        request.setReason(refund.getReason());\n        return request;\n    }\n    \n    private String getNotifyUrl(String channel) {\n        return \"https://api.example.com/payment/callback/\" + channel;\n    }\n    \n    private String getReturnUrl(String channel) {\n        return \"https://www.example.com/payment/return/\" + channel;\n    }\n    \n    private void sendPaymentSuccessMessage(Payment payment) {\n        PaymentMessage message = new PaymentMessage();\n        message.setPaymentNo(payment.getPaymentNo());\n        message.setOrderId(payment.getOrderId());\n        message.setUserId(payment.getUserId());\n        message.setAmount(payment.getAmount());\n        message.setAction(\"PAYMENT_SUCCESS\");\n        \n        rabbitTemplate.convertAndSend(\"payment.exchange\", \"payment.success\", message);\n    }\n    \n    private void sendPaymentFailedMessage(Payment payment) {\n        PaymentMessage message = new PaymentMessage();\n        message.setPaymentNo(payment.getPaymentNo());\n        message.setOrderId(payment.getOrderId());\n        message.setUserId(payment.getUserId());\n        message.setAmount(payment.getAmount());\n        message.setAction(\"PAYMENT_FAILED\");\n        \n        rabbitTemplate.convertAndSend(\"payment.exchange\", \"payment.failed\", message);\n    }\n    \n    private void sendRefundMessage(Refund refund) {\n        PaymentMessage message = new PaymentMessage();\n        message.setRefundNo(refund.getRefundNo());\n        message.setPaymentNo(refund.getPaymentNo());\n        message.setAmount(refund.getAmount());\n        message.setAction(\"REFUND\");\n        \n        rabbitTemplate.convertAndSend(\"payment.exchange\", \"refund.created\", message);\n    }\n    \n    private Payment getPayment(String paymentNo) {\n        return paymentRepository.findByPaymentNo(paymentNo)\n            .orElseThrow(() -\u003e new BusinessException(\"支付记录不存在\"));\n    }\n}\n```\n\n### 2. 支付渠道管理\n\n**支付渠道服务**\n```java\n@Service\npublic class PaymentChannelService {\n    \n    @Autowired\n    private Map\u003cString, PaymentChannel\u003e channelMap;\n    \n    @PostConstruct\n    public void initChannels() {\n        channelMap.put(\"ALIPAY\", new AlipayChannel());\n        channelMap.put(\"WECHAT\", new WechatChannel());\n        channelMap.put(\"UNIONPAY\", new UnionpayChannel());\n    }\n    \n    public PaymentChannel getChannel(String channel) {\n        PaymentChannel paymentChannel = channelMap.get(channel.toUpperCase());\n        if (paymentChannel == null) {\n            throw new BusinessException(\"不支持的支付渠道\");\n        }\n        return paymentChannel;\n    }\n    \n    public List\u003cPaymentChannel\u003e getAvailableChannels() {\n        return new ArrayList\u003c\u003e(channelMap.values());\n    }\n}\n\n// 支付渠道接口\npublic interface PaymentChannel {\n    \n    ThirdPartyPaymentResponse createPayment(ThirdPartyPaymentRequest request);\n    \n    ThirdPartyPaymentStatus queryPaymentStatus(String thirdPartyPaymentNo);\n    \n    ThirdPartyRefundResponse createRefund(ThirdPartyRefundRequest request);\n    \n    boolean verifyCallback(PaymentCallbackRequest request);\n}\n\n// 支付宝渠道实现\n@Component\npublic class AlipayChannel implements PaymentChannel {\n    \n    @Value(\"${alipay.app.id}\")\n    private String appId;\n    \n    @Value(\"${alipay.private.key}\")\n    private String privateKey;\n    \n    @Value(\"${alipay.public.key}\")\n    private String publicKey;\n    \n    @Override\n    public ThirdPartyPaymentResponse createPayment(ThirdPartyPaymentRequest request) {\n        try {\n            AlipayClient alipayClient = new DefaultAlipayClient(\n                \"https://openapi.alipay.com/gateway.do\",\n                appId,\n                privateKey,\n                \"json\",\n                \"UTF-8\",\n                publicKey,\n                \"RSA2\"\n            );\n            \n            AlipayTradePagePayRequest alipayRequest = new AlipayTradePagePayRequest();\n            alipayRequest.setReturnUrl(request.getReturnUrl());\n            alipayRequest.setNotifyUrl(request.getNotifyUrl());\n            \n            alipayRequest.setBizContent(String.format(\n                \"{\\\"out_trade_no\\\":\\\"%s\\\",\\\"total_amount\\\":\\\"%s\\\",\\\"subject\\\":\\\"%s\\\"}\",\n                request.getOutTradeNo(),\n                request.getAmount(),\n                request.getSubject()\n            ));\n            \n            AlipayTradePagePayResponse response = alipayClient.pageExecute(alipayRequest);\n            \n            ThirdPartyPaymentResponse result = new ThirdPartyPaymentResponse();\n            result.setSuccess(response.isSuccess());\n            result.setPaymentNo(response.getOutTradeNo());\n            result.setPayUrl(response.getBody());\n            \n            return result;\n        } catch (AlipayApiException e) {\n            throw new BusinessException(\"支付宝支付失败\");\n        }\n    }\n    \n    @Override\n    public ThirdPartyPaymentStatus queryPaymentStatus(String thirdPartyPaymentNo) {\n        try {\n            AlipayClient alipayClient = new DefaultAlipayClient(\n                \"https://openapi.alipay.com/gateway.do\",\n                appId,\n                privateKey,\n                \"json\",\n                \"UTF-8\",\n                publicKey,\n                \"RSA2\"\n            );\n            \n            AlipayTradeQueryRequest request = new AlipayTradeQueryRequest();\n            request.setBizContent(String.format(\n                \"{\\\"out_trade_no\\\":\\\"%s\\\"}\",\n                thirdPartyPaymentNo\n            ));\n            \n            AlipayTradeQueryResponse response = alipayClient.execute(request);\n            \n            if (response.isSuccess()) {\n                if (\"TRADE_SUCCESS\".equals(response.getTradeStatus()) || \n                    \"TRADE_FINISHED\".equals(response.getTradeStatus())) {\n                    return ThirdPartyPaymentStatus.SUCCESS;\n                } else if (\"WAIT_BUYER_PAY\".equals(response.getTradeStatus())) {\n                    return ThirdPartyPaymentStatus.PENDING;\n                } else {\n                    return ThirdPartyPaymentStatus.FAILED;\n                }\n            } else {\n                return ThirdPartyPaymentStatus.FAILED;\n            }\n        } catch (AlipayApiException e) {\n            throw new BusinessException(\"查询支付状态失败\");\n        }\n    }\n    \n    @Override\n    public ThirdPartyRefundResponse createRefund(ThirdPartyRefundRequest request) {\n        try {\n            AlipayClient alipayClient = new DefaultAlipayClient(\n                \"https://openapi.alipay.com/gateway.do\",\n                appId,\n                privateKey,\n                \"json\",\n                \"UTF-8\",\n                publicKey,\n                \"RSA2\"\n            );\n            \n            AlipayTradeRefundRequest alipayRequest = new AlipayTradeRefundRequest();\n            alipayRequest.setBizContent(String.format(\n                \"{\\\"out_trade_no\\\":\\\"%s\\\",\\\"refund_amount\\\":\\\"%s\\\",\\\"refund_reason\\\":\\\"%s\\\"}\",\n                request.getOutRefundNo(),\n                request.getAmount(),\n                request.getReason()\n            ));\n            \n            AlipayTradeRefundResponse response = alipayClient.execute(alipayRequest);\n            \n            ThirdPartyRefundResponse result = new ThirdPartyRefundResponse();\n            result.setSuccess(response.isSuccess());\n            result.setRefundNo(response.getOutTradeNo());\n            \n            return result;\n        } catch (AlipayApiException e) {\n            throw new BusinessException(\"支付宝退款失败\");\n        }\n    }\n    \n    @Override\n    public boolean verifyCallback(PaymentCallbackRequest request) {\n        try {\n            Map\u003cString, String\u003e params = request.getParams();\n            \n            // 验证签名\n            return AlipaySignature.rsaCheckV1(\n                params,\n                publicKey,\n                \"UTF-8\",\n                \"RSA2\"\n            );\n        } catch (AlipayApiException e) {\n            return false;\n        }\n    }\n}\n```\n\n## 风险控制\n\n### 1. 风险评估\n\n**风险控制服务**\n```java\n@Service\npublic class RiskControlService {\n    \n    @Autowired\n    private RiskRuleRepository riskRuleRepository;\n    \n    @Autowired\n    private RedisTemplate\u003cString, String\u003e redisTemplate;\n    \n    // 支付风险检查\n    public RiskCheckResult checkPaymentRisk(Long userId, BigDecimal amount, String ip) {\n        RiskCheckResult result = new RiskCheckResult();\n        \n        // 1. 用户风险检查\n        int userRiskScore = checkUserRisk(userId);\n        \n        // 2. 金额风险检查\n        int amountRiskScore = checkAmountRisk(userId, amount);\n        \n        // 3. IP风险检查\n        int ipRiskScore = checkIpRisk(ip);\n        \n        // 4. 频率风险检查\n        int frequencyRiskScore = checkFrequencyRisk(userId);\n        \n        // 5. 设备风险检查\n        int deviceRiskScore = checkDeviceRisk(userId, request.getDeviceId());\n        \n        // 计算总风险分数\n        int totalRiskScore = userRiskScore + amountRiskScore + ipRiskScore + \n                           frequencyRiskScore + deviceRiskScore;\n        \n        result.setRiskScore(totalRiskScore);\n        result.setHighRisk(totalRiskScore \u003e 80);\n        \n        // 记录风险检查日志\n        recordRiskCheck(userId, amount, ip, totalRiskScore);\n        \n        return result;\n    }\n    \n    // 用户风险检查\n    private int checkUserRisk(Long userId) {\n        UserRiskProfile profile = getUserRiskProfile(userId);\n        \n        int riskScore = 0;\n        \n        // 检查用户注册时间\n        if (profile.getRegisterTime().after(DateUtils.addDays(new Date(), -7))) {\n            riskScore += 20;\n        }\n        \n        // 检查用户认证状态\n        if (!profile.isRealNameVerified()) {\n            riskScore += 15;\n        }\n        \n        // 检查用户历史风险记录\n        if (profile.getRiskCount() \u003e 0) {\n            riskScore += 10 * profile.getRiskCount();\n        }\n        \n        // 检查用户支付频率\n        if (profile.getPaymentCount() \u003e 100) {\n            riskScore += 5;\n        }\n        \n        return riskScore;\n    }\n    \n    // 金额风险检查\n    private int checkAmountRisk(Long userId, BigDecimal amount) {\n        int riskScore = 0;\n        \n        // 获取用户历史支付金额\n        BigDecimal avgAmount = getUserAveragePaymentAmount(userId);\n        \n        // 检查支付金额是否异常\n        if (amount.compareTo(avgAmount.multiply(new BigDecimal(\"5\"))) \u003e 0) {\n            riskScore += 25;\n        } else if (amount.compareTo(avgAmount.multiply(new BigDecimal(\"3\"))) \u003e 0) {\n            riskScore += 15;\n        }\n        \n        // 检查大额支付\n        if (amount.compareTo(new BigDecimal(\"10000\")) \u003e 0) {\n            riskScore += 20;\n        }\n        \n        return riskScore;\n    }\n    \n    // IP风险检查\n    private int checkIpRisk(String ip) {\n        int riskScore = 0;\n        \n        // 检查IP是否在黑名单中\n        if (isIpInBlacklist(ip)) {\n            riskScore += 50;\n        }\n        \n        // 检查IP地理位置\n        String location = getIpLocation(ip);\n        if (isHighRiskLocation(location)) {\n            riskScore += 20;\n        }\n        \n        // 检查IP代理\n        if (isProxyIp(ip)) {\n            riskScore += 30;\n        }\n        \n        return riskScore;\n    }\n    \n    // 频率风险检查\n    private int checkFrequencyRisk(Long userId) {\n        int riskScore = 0;\n        \n        // 检查最近1小时内的支付次数\n        int hourCount = getPaymentCount(userId, 1);\n        if (hourCount \u003e 10) {\n            riskScore += 20;\n        }\n        \n        // 检查最近24小时内的支付次数\n        int dayCount = getPaymentCount(userId, 24);\n        if (dayCount \u003e 50) {\n            riskScore += 15;\n        }\n        \n        return riskScore;\n    }\n    \n    // 设备风险检查\n    private int checkDeviceRisk(Long userId, String deviceId) {\n        int riskScore = 0;\n        \n        // 检查设备是否为新设备\n        if (!isKnownDevice(userId, deviceId)) {\n            riskScore += 10;\n        }\n        \n        // 检查设备风险等级\n        int deviceRiskLevel = getDeviceRiskLevel(deviceId);\n        riskScore += deviceRiskLevel * 5;\n        \n        return riskScore;\n    }\n    \n    // 记录风险检查日志\n    private void recordRiskCheck(Long userId, BigDecimal amount, String ip, int riskScore) {\n        RiskCheckLog log = new RiskCheckLog();\n        log.setUserId(userId);\n        log.setAmount(amount);\n        log.setIp(ip);\n        log.setRiskScore(riskScore);\n        log.setCheckTime(new Date());\n        \n        riskCheckLogRepository.save(log);\n        \n        // 如果风险分数过高，发送告警\n        if (riskScore \u003e 80) {\n            sendRiskAlert(userId, amount, ip, riskScore);\n        }\n    }\n    \n    private void sendRiskAlert(Long userId, BigDecimal amount, String ip, int riskScore) {\n        RiskAlert alert = new RiskAlert();\n        alert.setUserId(userId);\n        alert.setAmount(amount);\n        alert.setIp(ip);\n        alert.setRiskScore(riskScore);\n        alert.setAlertTime(new Date());\n        \n        // 发送告警通知\n        notificationService.sendRiskAlert(alert);\n    }\n    \n    private UserRiskProfile getUserRiskProfile(Long userId) {\n        // 从数据库获取用户风险档案\n        return userRiskProfileRepository.findByUserId(userId);\n    }\n    \n    private BigDecimal getUserAveragePaymentAmount(Long userId) {\n        // 计算用户平均支付金额\n        return paymentRepository.calculateAverageAmountByUserId(userId);\n    }\n    \n    private boolean isIpInBlacklist(String ip) {\n        String key = \"risk:ip:blacklist\";\n        return redisTemplate.opsForSet().isMember(key, ip);\n    }\n    \n    private String getIpLocation(String ip) {\n        // 调用IP地理位置服务\n        return ipLocationService.getLocation(ip);\n    }\n    \n    private boolean isHighRiskLocation(String location) {\n        List\u003cString\u003e highRiskLocations = Arrays.asList(\"XX\", \"YY\", \"ZZ\");\n        return highRiskLocations.contains(location);\n    }\n    \n    private boolean isProxyIp(String ip) {\n        // 检查是否为代理IP\n        return ipDetectionService.isProxyIp(ip);\n    }\n    \n    private int getPaymentCount(Long userId, int hours) {\n        // 获取指定小时内的支付次数\n        return paymentRepository.countByUserIdAndTimeRange(userId, hours);\n    }\n    \n    private boolean isKnownDevice(Long userId, String deviceId) {\n        String key = \"user:device:\" + userId;\n        return redisTemplate.opsForSet().isMember(key, deviceId);\n    }\n    \n    private int getDeviceRiskLevel(String deviceId) {\n        // 获取设备风险等级\n        return deviceRiskService.getRiskLevel(deviceId);\n    }\n}\n```\n\n## 对账系统\n\n### 1. 对账服务\n\n**对账服务实现**\n```java\n@Service\npublic class ReconciliationService {\n    \n    @Autowired\n    private ReconciliationRepository reconciliationRepository;\n    \n    @Autowired\n    private PaymentRepository paymentRepository;\n    \n    @Scheduled(cron = \"0 0 2 * * ?\") // 每天凌晨2点执行\n    public void dailyReconciliation() {\n        String yesterday = DateUtils.formatDate(DateUtils.addDays(new Date(), -1));\n        \n        // 1. 获取内部账单\n        List\u003cInternalBill\u003e internalBills = getInternalBills(yesterday);\n        \n        // 2. 获取第三方账单\n        List\u003cThirdPartyBill\u003e thirdPartyBills = getThirdPartyBills(yesterday);\n        \n        // 3. 执行对账\n        ReconciliationResult result = reconcile(internalBills, thirdPartyBills);\n        \n        // 4. 保存对账结果\n        saveReconciliationResult(yesterday, result);\n        \n        // 5. 处理差异\n        if (result.hasDiscrepancy()) {\n            handleDiscrepancies(result.getDiscrepancies());\n        }\n    }\n    \n    // 获取内部账单\n    private List\u003cInternalBill\u003e getInternalBills(String date) {\n        return paymentRepository.findByDate(date)\n            .stream()\n            .map(this::convertToInternalBill)\n            .collect(Collectors.toList());\n    }\n    \n    // 获取第三方账单\n    private List\u003cThirdPartyBill\u003e getThirdPartyBills(String date) {\n        List\u003cThirdPartyBill\u003e bills = new ArrayList\u003c\u003e();\n        \n        // 获取支付宝账单\n        bills.addAll(getAlipayBills(date));\n        \n        // 获取微信账单\n        bills.addAll(getWechatBills(date));\n        \n        // 获取银联账单\n        bills.addAll(getUnionpayBills(date));\n        \n        return bills;\n    }\n    \n    // 执行对账\n    private ReconciliationResult reconcile(List\u003cInternalBill\u003e internalBills, \n                                         List\u003cThirdPartyBill\u003e thirdPartyBills) {\n        ReconciliationResult result = new ReconciliationResult();\n        \n        // 按支付单号分组\n        Map\u003cString, InternalBill\u003e internalBillMap = internalBills.stream()\n            .collect(Collectors.toMap(InternalBill::getPaymentNo, Function.identity()));\n        \n        Map\u003cString, ThirdPartyBill\u003e thirdPartyBillMap = thirdPartyBills.stream()\n            .collect(Collectors.toMap(ThirdPartyBill::getPaymentNo, Function.identity()));\n        \n        // 检查内部账单在第三方账单中是否存在\n        for (InternalBill internalBill : internalBills) {\n            ThirdPartyBill thirdPartyBill = thirdPartyBillMap.get(internalBill.getPaymentNo());\n            \n            if (thirdPartyBill == null) {\n                // 第三方账单缺失\n                result.addDiscrepancy(new Discrepancy(\n                    internalBill.getPaymentNo(),\n                    DiscrepancyType.THIRD_PARTY_MISSING,\n                    internalBill.getAmount(),\n                    BigDecimal.ZERO\n                ));\n            } else {\n                // 检查金额是否一致\n                if (!internalBill.getAmount().equals(thirdPartyBill.getAmount())) {\n                    result.addDiscrepancy(new Discrepancy(\n                        internalBill.getPaymentNo(),\n                        DiscrepancyType.AMOUNT_MISMATCH,\n                        internalBill.getAmount(),\n                        thirdPartyBill.getAmount()\n                    ));\n                }\n                \n                // 检查状态是否一致\n                if (!internalBill.getStatus().equals(thirdPartyBill.getStatus())) {\n                    result.addDiscrepancy(new Discrepancy(\n                        internalBill.getPaymentNo(),\n                        DiscrepancyType.STATUS_MISMATCH,\n                        internalBill.getStatus(),\n                        thirdPartyBill.getStatus()\n                    ));\n                }\n                \n                // 从第三方账单中移除已匹配的账单\n                thirdPartyBillMap.remove(internalBill.getPaymentNo());\n            }\n        }\n        \n        // 检查第三方账单中多余的账单\n        for (ThirdPartyBill thirdPartyBill : thirdPartyBillMap.values()) {\n            result.addDiscrepancy(new Discrepancy(\n                thirdPartyBill.getPaymentNo(),\n                DiscrepancyType.INTERNAL_MISSING,\n                BigDecimal.ZERO,\n                thirdPartyBill.getAmount()\n            ));\n        }\n        \n        return result;\n    }\n    \n    // 处理差异\n    private void handleDiscrepancies(List\u003cDiscrepancy\u003e discrepancies) {\n        for (Discrepancy discrepancy : discrepancies) {\n            switch (discrepancy.getType()) {\n                case THIRD_PARTY_MISSING:\n                    handleThirdPartyMissing(discrepancy);\n                    break;\n                case INTERNAL_MISSING:\n                    handleInternalMissing(discrepancy);\n                    break;\n                case AMMOUNT_MISMATCH:\n                    handleAmountMismatch(discrepancy);\n                    break;\n                case STATUS_MISMATCH:\n                    handleStatusMismatch(discrepancy);\n                    break;\n            }\n        }\n    }\n    \n    // 处理第三方账单缺失\n    private void handleThirdPartyMissing(Discrepancy discrepancy) {\n        // 查询第三方支付状态\n        Payment payment = paymentRepository.findByPaymentNo(discrepancy.getPaymentNo());\n        \n        PaymentChannel channel = channelService.getChannel(payment.getChannel());\n        ThirdPartyPaymentStatus status = channel.queryPaymentStatus(\n            payment.getThirdPartyPaymentNo());\n        \n        if (status == ThirdPartyPaymentStatus.SUCCESS) {\n            // 更新支付状态\n            payment.setStatus(PaymentStatus.SUCCESS);\n            payment.setPayTime(new Date());\n            paymentRepository.save(payment);\n            \n            // 更新订单状态\n            orderService.handlePaymentSuccess(payment.getOrderId());\n        } else if (status == ThirdPartyPaymentStatus.FAILED) {\n            // 更新支付状态\n            payment.setStatus(PaymentStatus.FAILED);\n            paymentRepository.save(payment);\n        }\n    }\n    \n    // 处理内部账单缺失\n    private void handleInternalMissing(Discrepancy discrepancy) {\n        // 创建缺失的内部账单\n        Payment payment = new Payment();\n        payment.setPaymentNo(discrepancy.getPaymentNo());\n        payment.setAmount(discrepancy.getThirdPartyAmount());\n        payment.setStatus(PaymentStatus.SUCCESS);\n        payment.setCreateTime(new Date());\n        \n        paymentRepository.save(payment);\n        \n        // 记录异常\n        recordReconciliationException(discrepancy, \"内部账单缺失\");\n    }\n    \n    // 处理金额不匹配\n    private void handleAmountMismatch(Discrepancy discrepancy) {\n        // 记录异常\n        recordReconciliationException(discrepancy, \"金额不匹配\");\n        \n        // 发送告警\n        sendReconciliationAlert(discrepancy);\n    }\n    \n    // 处理状态不匹配\n    private void handleStatusMismatch(Discrepancy discrepancy) {\n        // 更新内部状态\n        Payment payment = paymentRepository.findByPaymentNo(discrepancy.getPaymentNo());\n        payment.setStatus(PaymentStatus.SUCCESS);\n        payment.setPayTime(new Date());\n        paymentRepository.save(payment);\n        \n        // 更新订单状态\n        orderService.handlePaymentSuccess(payment.getOrderId());\n    }\n    \n    // 记录对账异常\n    private void recordReconciliationException(Discrepancy discrepancy, String reason) {\n        ReconciliationException exception = new ReconciliationException();\n        exception.setPaymentNo(discrepancy.getPaymentNo());\n        exception.setReason(reason);\n        exception.setInternalAmount(discrepancy.getInternalAmount());\n        exception.setThirdPartyAmount(discrepancy.getThirdPartyAmount());\n        exception.setCreateTime(new Date());\n        \n        reconciliationExceptionRepository.save(exception);\n    }\n    \n    // 发送对账告警\n    private void sendReconciliationAlert(Discrepancy discrepancy) {\n        ReconciliationAlert alert = new ReconciliationAlert();\n        alert.setPaymentNo(discrepancy.getPaymentNo());\n        alert.setType(discrepancy.getType());\n        alert.setInternalAmount(discrepancy.getInternalAmount());\n        alert.setThirdPartyAmount(discrepancy.getThirdPartyAmount());\n        alert.setAlertTime(new Date());\n        \n        notificationService.sendReconciliationAlert(alert);\n    }\n    \n    private InternalBill convertToInternalBill(Payment payment) {\n        InternalBill bill = new InternalBill();\n        bill.setPaymentNo(payment.getPaymentNo());\n        bill.setAmount(payment.getAmount());\n        bill.setStatus(payment.getStatus());\n        bill.setPayTime(payment.getPayTime());\n        return bill;\n    }\n    \n    private List\u003cThirdPartyBill\u003e getAlipayBills(String date) {\n        // 调用支付宝账单接口\n        return alipayService.getBills(date);\n    }\n    \n    private List\u003cThirdPartyBill\u003e getWechatBills(String date) {\n        // 调用微信账单接口\n        return wechatService.getBills(date);\n    }\n    \n    private List\u003cThirdPartyBill\u003e getUnionpayBills(String date) {\n        // 调用银联账单接口\n        return unionpayService.getBills(date);\n    }\n}\n```\n\n## 总结\n\n支付系统设计需要考虑以下关键点：\n\n1. **安全性**：确保支付过程的安全可靠\n2. **一致性**：保证支付状态与业务状态的一致性\n3. **可靠性**：确保支付流程的稳定运行\n4. **扩展性**：支持多种支付渠道的接入\n5. **监控性**：完善的监控和对账机制\n\n通过合理的架构设计和严格的流程控制，可以构建安全、可靠的支付系统。"])</script><script>self.__next_f.push([1,"4:[\"$\",\"div\",null,{\"children\":[[\"$\",\"$Ld\",null,{\"href\":\"/notes\",\"className\":\"back-button\",\"style\":{\"display\":\"inline-block\",\"background\":\"var(--primary-color)\",\"color\":\"white\",\"border\":\"none\",\"padding\":\"10px 20px\",\"borderRadius\":\"6px\",\"cursor\":\"pointer\",\"marginBottom\":\"20px\",\"textDecoration\":\"none\"},\"children\":[\"← 返回\",\"笔记\",\"列表\"]}],[\"$\",\"article\",null,{\"className\":\"section\",\"children\":[[\"$\",\"header\",null,{\"className\":\"article-header\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"article-title\",\"children\":\"支付系统设计详解\"}],[\"$\",\"div\",null,{\"className\":\"article-meta\",\"children\":[\"$\",\"div\",null,{\"className\":\"article-tags\",\"children\":[[\"$\",\"span\",\"支付系统\",{\"className\":\"tag\",\"children\":\"支付系统\"}],[\"$\",\"span\",\"系统设计\",{\"className\":\"tag\",\"children\":\"系统设计\"}],[\"$\",\"span\",\"金融安全\",{\"className\":\"tag\",\"children\":\"金融安全\"}],[\"$\",\"span\",\"第三方支付\",{\"className\":\"tag\",\"children\":\"第三方支付\"}],[\"$\",\"span\",\"对账系统\",{\"className\":\"tag\",\"children\":\"对账系统\"}]]}]}]]}],[\"$\",\"div\",null,{\"className\":\"card markdown-content\",\"children\":[\"$\",\"$Le\",null,{\"content\":\"$f\"}]}]]}]]}]\n"])</script><script>self.__next_f.push([1,"9:[\"$\",\"html\",null,{\"lang\":\"zh-CN\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css\"}],[\"$\",\"script\",null,{\"src\":\"https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js\"}]]}],[\"$\",\"body\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"app\",\"children\":[[\"$\",\"$L10\",null,{\"siteConfig\":{\"name\":\"Rudy Yang\",\"bio\":\"JAVA | AI | WEB3\",\"social\":[{\"name\":\"github\",\"icon\":\"fab fa-github\",\"url\":\"https://github.com/suogongy\"},{\"name\":\"twitter\",\"icon\":\"fab fa-twitter\",\"url\":\"https://twitter.com/suogongy\"},{\"name\":\"email\",\"icon\":\"fas fa-envelope\",\"url\":\"mailto:haiyuan1832@163.com\"}]}}],[\"$\",\"main\",null,{\"className\":\"main-content\",\"children\":[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[]}]}]]}]}]]}]\n"])</script><script>self.__next_f.push([1,"a:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"支付系统设计详解 - Personal GitHub Page\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"深入分析支付系统的架构设计、核心业务流程、安全机制、对账系统等关键模块，帮助构建安全可靠的支付系统。\"}]]\n3:null\n"])</script></body></html>