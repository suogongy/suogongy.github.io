<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/7b42d4e858e38c6b.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-c81f7fd28659d64f.js"/><script src="/_next/static/chunks/fd9d1056-e3d373074663785d.js" async=""></script><script src="/_next/static/chunks/117-86f31d03f8df68a5.js" async=""></script><script src="/_next/static/chunks/main-app-1bdc7b9537d0c130.js" async=""></script><script src="/_next/static/chunks/972-81dbad6abe39d3fa.js" async=""></script><script src="/_next/static/chunks/832-2b131d9fe9982edb.js" async=""></script><script src="/_next/static/chunks/app/%5Bcategory%5D/%5Bslug%5D/page-eb51aa11033a73a2.js" async=""></script><script src="/_next/static/chunks/app/layout-f3fa7e3100be56de.js" async=""></script><script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js" async=""></script><title>电商系统设计详解 - Personal GitHub Page</title><meta name="description" content="深入分析电商系统的整体架构设计，包括用户管理、商品管理、订单管理、支付系统、搜索系统等核心模块的设计思路和实现方案。"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"/><script src="https://unpkg.com/markmap-autoloader@0.17.2"></script><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><div class="app"><header class="header "><nav class="nav-container"><a class="nav-brand" href="/"><i class="fas fa-terminal"></i>海元</a><ul class="nav-menu "><li><a class="nav-link " href="/"><i class="fas fa-home"></i> 首页</a></li><li><a class="nav-link " href="/about/"><i class="fas fa-user"></i> 关于</a></li><li><a class="nav-link " href="/projects/"><i class="fas fa-code"></i> 项目</a></li><li><a class="nav-link " href="/notes/"><i class="fas fa-book"></i> 笔记</a></li><li><a class="nav-link " href="/articles/"><i class="fas fa-pen"></i> 随笔</a></li></ul></nav></header><main class="main-content"><div><a class="back-button" style="display:inline-block;background:var(--primary-color);color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;margin-bottom:20px;text-decoration:none" href="/notes/">← 返回<!-- -->笔记<!-- -->列表</a><article class="section"><header class="article-header"><h1 class="article-title">电商系统设计详解</h1><div class="article-meta"><div class="article-tags"><span class="tag">电商系统</span><span class="tag">系统设计</span><span class="tag">架构设计</span><span class="tag">微服务</span><span class="tag">高并发</span></div></div></header><div class="card markdown-content"><div class="markdown-content"><div><h1>电商系统设计详解</h1>
<blockquote>
<p>电商系统是复杂业务系统的典型代表，其架构设计涵盖了多个技术领域</p>
</blockquote>
<h2>电商系统概述</h2>
<h3>1. 系统架构图</h3>
<pre><code>电商系统架构：
┌─────────────────────────────────────────────────────────────┐
│                    前端应用层                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │   Web       │ │   Mobile    │ │   Mini      │           │
│  │   App       │ │   App       │ │   Program   │           │
│  └─────────────┘  └─────────────┘  └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                          │
                    ┌─────────────┐
                    │  API        │
                    │  Gateway    │
                    └─────────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │  User       │ │  Product    │ │  Order      │
    │  Service    │ │  Service    │ │  Service    │
    └─────────────┘ └─────────────┘ └─────────────┘
          │               │               │
          └───────────────┼───────────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │  Payment    │ │  Search     │ │  Inventory  │
    │  Service    │ │  Service    │ │  Service    │
    └─────────────┘ └─────────────┘ └─────────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │  MySQL      │ │  Redis      │ │  MQ         │
    │  Cluster    │ │  Cluster    │ │  Cluster    │
    └─────────────┘ └─────────────┘ └─────────────┘
</code></pre>
<h3>2. 核心业务模块</h3>
<pre><code>核心业务模块：
├── 用户中心
│   ├── 用户注册登录
│   ├── 用户信息管理
│   ├── 地址管理
│   └── 会员体系
├── 商品中心
│   ├── 商品管理
│   ├── 分类管理
│   ├── 品牌管理
│   └── 库存管理
├── 订单中心
│   ├── 订单创建
│   ├── 订单查询
│   ├── 订单状态管理
│   └── 订单统计
├── 支付中心
│   ├── 支付接口
│   ├── 支付回调
│   ├── 退款处理
│   └── 对账管理
├── 搜索中心
│   ├── 商品搜索
│   ├── 搜索推荐
│   ├── 搜索统计
│   └── 搜索优化
└── 营销中心
    ├── 优惠券
    ├── 秒杀活动
    ├── 拼团活动
    └── 积分系统
</code></pre>
<h2>用户中心设计</h2>
<h3>1. 用户注册登录</h3>
<p><strong>用户服务实现</strong></p>
<pre><code class="language-java">@Service
@Transactional
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Autowired
    private JwtAuthenticationService jwtService;
    
    @Autowired
    private RedisTemplate&lt;String, String&gt; redisTemplate;
    
    // 用户注册
    public User register(UserRegistrationRequest request) {
        // 1. 验证用户名唯一性
        if (userRepository.existsByUsername(request.getUsername())) {
            throw new BusinessException(&quot;用户名已存在&quot;);
        }
        
        // 2. 验证邮箱唯一性
        if (userRepository.existsByEmail(request.getEmail())) {
            throw new BusinessException(&quot;邮箱已存在&quot;);
        }
        
        // 3. 验证手机号唯一性
        if (userRepository.existsByPhone(request.getPhone())) {
            throw new BusinessException(&quot;手机号已存在&quot;);
        }
        
        // 4. 创建用户
        User user = new User();
        user.setUsername(request.getUsername());
        user.setEmail(request.getEmail());
        user.setPhone(request.getPhone());
        user.setPassword(passwordEncoder.encode(request.getPassword()));
        user.setStatus(UserStatus.ACTIVE);
        user.setCreateTime(new Date());
        
        return userRepository.save(user);
    }
    
    // 用户登录
    public LoginResponse login(LoginRequest request) {
        // 1. 验证用户名密码
        User user = userRepository.findByUsername(request.getUsername())
            .orElseThrow(() -&gt; new BusinessException(&quot;用户名或密码错误&quot;));
        
        if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
            throw new BusinessException(&quot;用户名或密码错误&quot;);
        }
        
        // 2. 检查用户状态
        if (user.getStatus() != UserStatus.ACTIVE) {
            throw new BusinessException(&quot;用户账号已被禁用&quot;);
        }
        
        // 3. 生成JWT Token
        String token = jwtService.generateToken(createUserDetails(user));
        
        // 4. 更新最后登录时间
        user.setLastLoginTime(new Date());
        userRepository.save(user);
        
        // 5. 记录登录日志
        recordLoginLog(user.getId(), request.getIp());
        
        return new LoginResponse(token, user);
    }
    
    // 发送验证码
    public void sendVerificationCode(String phone) {
        // 1. 生成验证码
        String code = generateVerificationCode();
        
        // 2. 存储验证码（5分钟过期）
        String key = &quot;verification:code:&quot; + phone;
        redisTemplate.opsForValue().set(key, code, 5, TimeUnit.MINUTES);
        
        // 3. 发送短信
        smsService.sendVerificationCode(phone, code);
    }
    
    // 验证手机号
    public boolean verifyPhone(String phone, String code) {
        String key = &quot;verification:code:&quot; + phone;
        String storedCode = redisTemplate.opsForValue().get(key);
        
        if (storedCode != null &amp;&amp; storedCode.equals(code)) {
            redisTemplate.delete(key);
            return true;
        }
        
        return false;
    }
    
    private String generateVerificationCode() {
        Random random = new Random();
        return String.format(&quot;%06d&quot;, random.nextInt(1000000));
    }
    
    private UserDetails createUserDetails(User user) {
        return org.springframework.security.core.userdetails.User.builder()
            .username(user.getUsername())
            .password(user.getPassword())
            .authorities(&quot;ROLE_USER&quot;)
            .build();
    }
    
    private void recordLoginLog(Long userId, String ip) {
        LoginLog log = new LoginLog();
        log.setUserId(userId);
        log.setIp(ip);
        log.setLoginTime(new Date());
        loginLogRepository.save(log);
    }
}
</code></pre>
<h3>2. 用户信息管理</h3>
<p><strong>用户信息更新</strong></p>
<pre><code class="language-java">@RestController
@RequestMapping(&quot;/api/users&quot;)
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @PutMapping(&quot;/profile&quot;)
    public Result updateUserProfile(@RequestBody UserProfileRequest request,
                                  @AuthenticationPrincipal UserDetails userDetails) {
        Long userId = getCurrentUserId(userDetails);
        
        User user = userService.updateUserProfile(userId, request);
        return Result.success(user);
    }
    
    @PostMapping(&quot;/avatar&quot;)
    public Result uploadAvatar(@RequestParam(&quot;file&quot;) MultipartFile file,
                              @AuthenticationPrincipal UserDetails userDetails) {
        Long userId = getCurrentUserId(userDetails);
        
        String avatarUrl = userService.uploadAvatar(userId, file);
        return Result.success(avatarUrl);
    }
    
    @GetMapping(&quot;/addresses&quot;)
    public Result&lt;List&lt;Address&gt;&gt; getUserAddresses(@AuthenticationPrincipal UserDetails userDetails) {
        Long userId = getCurrentUserId(userDetails);
        
        List&lt;Address&gt; addresses = userService.getUserAddresses(userId);
        return Result.success(addresses);
    }
    
    @PostMapping(&quot;/addresses&quot;)
    public Result&lt;Address&gt; addAddress(@RequestBody AddressRequest request,
                                      @AuthenticationPrincipal UserDetails userDetails) {
        Long userId = getCurrentUserId(userDetails);
        
        Address address = userService.addAddress(userId, request);
        return Result.success(address);
    }
    
    @PutMapping(&quot;/addresses/{addressId}&quot;)
    public Result&lt;Address&gt; updateAddress(@PathVariable Long addressId,
                                         @RequestBody AddressRequest request,
                                         @AuthenticationPrincipal UserDetails userDetails) {
        Long userId = getCurrentUserId(userDetails);
        
        Address address = userService.updateAddress(userId, addressId, request);
        return Result.success(address);
    }
    
    @DeleteMapping(&quot;/addresses/{addressId}&quot;)
    public Result deleteAddress(@PathVariable Long addressId,
                                @AuthenticationPrincipal UserDetails userDetails) {
        Long userId = getCurrentUserId(userDetails);
        
        userService.deleteAddress(userId, addressId);
        return Result.success();
    }
}
</code></pre>
<h2>商品中心设计</h2>
<h3>1. 商品管理</h3>
<p><strong>商品服务实现</strong></p>
<pre><code class="language-java">@Service
@Transactional
public class ProductService {
    
    @Autowired
    private ProductRepository productRepository;
    
    @Autowired
    private CategoryService categoryService;
    
    @Autowired
    private BrandService brandService;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private SearchService searchService;
    
    // 创建商品
    public Product createProduct(ProductCreateRequest request) {
        // 1. 验证分类是否存在
        Category category = categoryService.getCategory(request.getCategoryId());
        if (category == null) {
            throw new BusinessException(&quot;分类不存在&quot;);
        }
        
        // 2. 验证品牌是否存在
        Brand brand = brandService.getBrand(request.getBrandId());
        if (brand == null) {
            throw new BusinessException(&quot;品牌不存在&quot;);
        }
        
        // 3. 创建商品
        Product product = new Product();
        product.setName(request.getName());
        product.setDescription(request.getDescription());
        product.setCategoryId(request.getCategoryId());
        product.setBrandId(request.getBrandId());
        product.setPrice(request.getPrice());
        product.setOriginalPrice(request.getOriginalPrice());
        product.setImages(request.getImages());
        product.setAttributes(request.getAttributes());
        product.setStatus(ProductStatus.ACTIVE);
        product.setCreateTime(new Date());
        
        product = productRepository.save(product);
        
        // 4. 初始化库存
        inventoryService.initInventory(product.getId(), request.getStock());
        
        // 5. 同步到搜索引擎
        searchService.indexProduct(product);
        
        return product;
    }
    
    // 更新商品
    public Product updateProduct(Long productId, ProductUpdateRequest request) {
        Product product = getProduct(productId);
        
        // 更新商品信息
        if (request.getName() != null) {
            product.setName(request.getName());
        }
        if (request.getDescription() != null) {
            product.setDescription(request.getDescription());
        }
        if (request.getPrice() != null) {
            product.setPrice(request.getPrice());
        }
        if (request.getImages() != null) {
            product.setImages(request.getImages());
        }
        if (request.getAttributes() != null) {
            product.setAttributes(request.getAttributes());
        }
        
        product.setUpdateTime(new Date());
        product = productRepository.save(product);
        
        // 同步到搜索引擎
        searchService.updateProduct(product);
        
        return product;
    }
    
    // 商品上下架
    public void changeProductStatus(Long productId, ProductStatus status) {
        Product product = getProduct(productId);
        product.setStatus(status);
        product.setUpdateTime(new Date());
        productRepository.save(product);
        
        // 同步到搜索引擎
        if (status == ProductStatus.ACTIVE) {
            searchService.indexProduct(product);
        } else {
            searchService.deleteProduct(productId);
        }
    }
    
    // 获取商品详情
    public Product getProductDetail(Long productId) {
        Product product = getProduct(productId);
        
        // 获取库存信息
        Integer stock = inventoryService.getStock(productId);
        product.setStock(stock);
        
        return product;
    }
    
    // 商品搜索
    public Page&lt;Product&gt; searchProducts(ProductSearchRequest request) {
        return searchService.searchProducts(request);
    }
    
    // 商品推荐
    public List&lt;Product&gt; recommendProducts(Long userId, int limit) {
        return searchService.recommendProducts(userId, limit);
    }
    
    private Product getProduct(Long productId) {
        return productRepository.findById(productId)
            .orElseThrow(() -&gt; new BusinessException(&quot;商品不存在&quot;));
    }
}
</code></pre>
<h3>2. 分类管理</h3>
<p><strong>分类服务实现</strong></p>
<pre><code class="language-java">@Service
@Transactional
public class CategoryService {
    
    @Autowired
    private CategoryRepository categoryRepository;
    
    @Autowired
    private RedisTemplate&lt;String, String&gt; redisTemplate;
    
    // 创建分类
    public Category createCategory(CategoryCreateRequest request) {
        // 验证父分类是否存在
        if (request.getParentId() != null) {
            Category parent = getCategory(request.getParentId());
            if (parent == null) {
                throw new BusinessException(&quot;父分类不存在&quot;);
            }
        }
        
        // 验证分类名称唯一性
        if (categoryRepository.existsByNameAndParentId(request.getName(), request.getParentId())) {
            throw new BusinessException(&quot;分类名称已存在&quot;);
        }
        
        Category category = new Category();
        category.setName(request.getName());
        category.setParentId(request.getParentId());
        category.setLevel(request.getParentId() == null ? 1 : 
            getCategory(request.getParentId()).getLevel() + 1);
        category.setSort(request.getSort());
        category.setIcon(request.getIcon());
        category.setStatus(CategoryStatus.ACTIVE);
        category.setCreateTime(new Date());
        
        category = categoryRepository.save(category);
        
        // 清除缓存
        clearCategoryCache();
        
        return category;
    }
    
    // 获取分类树
    public List&lt;CategoryTree&gt; getCategoryTree() {
        String cacheKey = &quot;category:tree&quot;;
        String cached = redisTemplate.opsForValue().get(cacheKey);
        
        if (cached != null) {
            return JSON.parseArray(cached, CategoryTree.class);
        }
        
        List&lt;Category&gt; allCategories = categoryRepository.findAllByStatus(CategoryStatus.ACTIVE);
        List&lt;CategoryTree&gt; tree = buildCategoryTree(allCategories, 0L);
        
        // 缓存结果
        redisTemplate.opsForValue().set(cacheKey, JSON.toJSONString(tree), 1, TimeUnit.HOURS);
        
        return tree;
    }
    
    // 获取子分类
    public List&lt;Category&gt; getChildCategories(Long parentId) {
        return categoryRepository.findByParentIdAndStatus(parentId, CategoryStatus.ACTIVE);
    }
    
    // 获取分类路径
    public List&lt;Category&gt; getCategoryPath(Long categoryId) {
        List&lt;Category&gt; path = new ArrayList&lt;&gt;();
        Category category = getCategory(categoryId);
        
        while (category != null) {
            path.add(0, category);
            category = category.getParentId() != null ? 
                getCategory(category.getParentId()) : null;
        }
        
        return path;
    }
    
    private List&lt;CategoryTree&gt; buildCategoryTree(List&lt;Category&gt; categories, Long parentId) {
        List&lt;CategoryTree&gt; tree = new ArrayList&lt;&gt;();
        
        for (Category category : categories) {
            if (Objects.equals(category.getParentId(), parentId)) {
                CategoryTree node = new CategoryTree();
                node.setId(category.getId());
                node.setName(category.getName());
                node.setIcon(category.getIcon());
                node.setChildren(buildCategoryTree(categories, category.getId()));
                tree.add(node);
            }
        }
        
        return tree;
    }
    
    private void clearCategoryCache() {
        redisTemplate.delete(&quot;category:tree&quot;);
    }
    
    public Category getCategory(Long categoryId) {
        if (categoryId == null) {
            return null;
        }
        return categoryRepository.findById(categoryId).orElse(null);
    }
}
</code></pre>
<h2>订单中心设计</h2>
<h3>1. 订单创建</h3>
<p><strong>订单服务实现</strong></p>
<pre><code class="language-java">@Service
@Transactional
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private OrderItemRepository orderItemRepository;
    
    @Autowired
    private ProductService productService;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private CartService cartService;
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // 创建订单
    public Order createOrder(OrderCreateRequest request, Long userId) {
        // 1. 验证商品信息
        List&lt;OrderItem&gt; orderItems = validateOrderItems(request.getItems());
        
        // 2. 计算订单金额
        OrderAmount amount = calculateOrderAmount(orderItems, request.getCouponId());
        
        // 3. 检查库存
        checkInventory(orderItems);
        
        // 4. 创建订单
        Order order = new Order();
        order.setOrderNo(generateOrderNo());
        order.setUserId(userId);
        order.setStatus(OrderStatus.PENDING_PAYMENT);
        order.setTotalAmount(amount.getTotalAmount());
        order.setDiscountAmount(amount.getDiscountAmount());
        order.setPayAmount(amount.getPayAmount());
        order.setShippingAddress(request.getShippingAddress());
        order.setRemark(request.getRemark());
        order.setCreateTime(new Date());
        
        order = orderRepository.save(order);
        
        // 5. 创建订单项
        for (OrderItem item : orderItems) {
            item.setOrderId(order.getId());
            orderItemRepository.save(item);
        }
        
        // 6. 锁定库存
        inventoryService.lockInventory(orderItems, order.getOrderNo());
        
        // 7. 清空购物车
        cartService.clearCart(userId, request.getItemIds());
        
        // 8. 发送订单创建消息
        sendOrderCreatedMessage(order);
        
        return order;
    }
    
    // 订单支付
    public PaymentResponse payOrder(Long orderId, PaymentRequest request) {
        Order order = getOrder(orderId);
        
        // 验证订单状态
        if (order.getStatus() != OrderStatus.PENDING_PAYMENT) {
            throw new BusinessException(&quot;订单状态不正确&quot;);
        }
        
        // 创建支付
        Payment payment = paymentService.createPayment(order, request);
        
        return new PaymentResponse(payment.getPaymentNo(), payment.getPayUrl());
    }
    
    // 订单支付成功
    public void handlePaymentSuccess(String paymentNo) {
        Payment payment = paymentService.getPaymentByNo(paymentNo);
        Order order = getOrder(payment.getOrderId());
        
        // 更新订单状态
        order.setStatus(OrderStatus.PAID);
        order.setPayTime(new Date());
        orderRepository.save(order);
        
        // 扣减库存
        inventoryService.deductInventory(payment.getOrderId());
        
        // 发送支付成功消息
        sendPaymentSuccessMessage(order);
    }
    
    // 订单发货
    public void shipOrder(Long orderId, ShipOrderRequest request) {
        Order order = getOrder(orderId);
        
        // 验证订单状态
        if (order.getStatus() != OrderStatus.PAID) {
            throw new BusinessException(&quot;订单状态不正确&quot;);
        }
        
        // 更新订单状态
        order.setStatus(OrderStatus.SHIPPED);
        order.setShippingCompany(request.getShippingCompany());
        order.setShippingNo(request.getShippingNo());
        order.setShippingTime(new Date());
        orderRepository.save(order);
        
        // 发送发货消息
        sendOrderShippedMessage(order);
    }
    
    // 确认收货
    public void confirmReceipt(Long orderId) {
        Order order = getOrder(orderId);
        
        // 验证订单状态
        if (order.getStatus() != OrderStatus.SHIPPED) {
            throw new BusinessException(&quot;订单状态不正确&quot;);
        }
        
        // 更新订单状态
        order.setStatus(OrderStatus.COMPLETED);
        order.setConfirmTime(new Date());
        orderRepository.save(order);
        
        // 发送确认收货消息
        sendOrderCompletedMessage(order);
    }
    
    // 取消订单
    public void cancelOrder(Long orderId, String reason) {
        Order order = getOrder(orderId);
        
        // 验证订单状态
        if (order.getStatus() != OrderStatus.PENDING_PAYMENT) {
            throw new BusinessException(&quot;订单状态不正确&quot;);
        }
        
        // 更新订单状态
        order.setStatus(OrderStatus.CANCELLED);
        order.setCancelReason(reason);
        order.setCancelTime(new Date());
        orderRepository.save(order);
        
        // 释放库存
        inventoryService.releaseInventory(orderId);
        
        // 发送订单取消消息
        sendOrderCancelledMessage(order);
    }
    
    private List&lt;OrderItem&gt; validateOrderItems(List&lt;OrderItemRequest&gt; items) {
        List&lt;OrderItem&gt; orderItems = new ArrayList&lt;&gt;();
        
        for (OrderItemRequest item : items) {
            Product product = productService.getProductDetail(item.getProductId());
            
            // 验证商品状态
            if (product.getStatus() != ProductStatus.ACTIVE) {
                throw new BusinessException(&quot;商品已下架&quot;);
            }
            
            // 验证库存
            if (product.getStock() &lt; item.getQuantity()) {
                throw new BusinessException(&quot;商品库存不足&quot;);
            }
            
            OrderItem orderItem = new OrderItem();
            orderItem.setProductId(product.getId());
            orderItem.setProductName(product.getName());
            orderItem.setProductImage(product.getImages().get(0));
            orderItem.setPrice(product.getPrice());
            orderItem.setQuantity(item.getQuantity());
            orderItem.setTotalAmount(product.getPrice() * item.getQuantity());
            
            orderItems.add(orderItem);
        }
        
        return orderItems;
    }
    
    private OrderAmount calculateOrderAmount(List&lt;OrderItem&gt; orderItems, Long couponId) {
        BigDecimal totalAmount = orderItems.stream()
            .map(OrderItem::getTotalAmount)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
        
        BigDecimal discountAmount = BigDecimal.ZERO;
        
        // 计算优惠券折扣
        if (couponId != null) {
            discountAmount = couponService.calculateDiscount(couponId, totalAmount);
        }
        
        BigDecimal payAmount = totalAmount.subtract(discountAmount);
        
        return new OrderAmount(totalAmount, discountAmount, payAmount);
    }
    
    private void checkInventory(List&lt;OrderItem&gt; orderItems) {
        for (OrderItem item : orderItems) {
            Integer stock = inventoryService.getStock(item.getProductId());
            if (stock &lt; item.getQuantity()) {
                throw new BusinessException(&quot;商品库存不足&quot;);
            }
        }
    }
    
    private String generateOrderNo() {
        return &quot;ORD&quot; + System.currentTimeMillis() + 
               String.format(&quot;%04d&quot;, new Random().nextInt(10000));
    }
    
    private void sendOrderCreatedMessage(Order order) {
        OrderMessage message = new OrderMessage();
        message.setOrderId(order.getId());
        message.setOrderNo(order.getOrderNo());
        message.setUserId(order.getUserId());
        message.setAction(&quot;ORDER_CREATED&quot;);
        
        rabbitTemplate.convertAndSend(&quot;order.exchange&quot;, &quot;order.created&quot;, message);
    }
    
    private void sendPaymentSuccessMessage(Order order) {
        OrderMessage message = new OrderMessage();
        message.setOrderId(order.getId());
        message.setOrderNo(order.getOrderNo());
        message.setUserId(order.getUserId());
        message.setAction(&quot;PAYMENT_SUCCESS&quot;);
        
        rabbitTemplate.convertAndSend(&quot;order.exchange&quot;, &quot;payment.success&quot;, message);
    }
    
    private void sendOrderShippedMessage(Order order) {
        OrderMessage message = new OrderMessage();
        message.setOrderId(order.getId());
        message.setOrderNo(order.getOrderNo());
        message.setUserId(order.getUserId());
        message.setAction(&quot;ORDER_SHIPPED&quot;);
        
        rabbitTemplate.convertAndSend(&quot;order.exchange&quot;, &quot;order.shipped&quot;, message);
    }
    
    private void sendOrderCompletedMessage(Order order) {
        OrderMessage message = new OrderMessage();
        message.setOrderId(order.getId());
        message.setOrderNo(order.getOrderNo());
        message.setUserId(order.getUserId());
        message.setAction(&quot;ORDER_COMPLETED&quot;);
        
        rabbitTemplate.convertAndSend(&quot;order.exchange&quot;, &quot;order.completed&quot;, message);
    }
    
    private void sendOrderCancelledMessage(Order order) {
        OrderMessage message = new OrderMessage();
        message.setOrderId(order.getId());
        message.setOrderNo(order.getOrderNo());
        message.setUserId(order.getUserId());
        message.setAction(&quot;ORDER_CANCELLED&quot;);
        
        rabbitTemplate.convertAndSend(&quot;order.exchange&quot;, &quot;order.cancelled&quot;, message);
    }
    
    private Order getOrder(Long orderId) {
        return orderRepository.findById(orderId)
            .orElseThrow(() -&gt; new BusinessException(&quot;订单不存在&quot;));
    }
}
</code></pre>
<h2>总结</h2>
<p>电商系统设计是一个复杂的工程，需要考虑：</p>
<ol>
<li><strong>业务复杂性</strong>：涵盖用户、商品、订单、支付等多个业务域</li>
<li><strong>高并发性</strong>：需要支持大量用户同时访问</li>
<li><strong>数据一致性</strong>：保证订单、库存等数据的一致性</li>
<li><strong>系统扩展性</strong>：支持业务快速发展和扩展</li>
<li><strong>用户体验</strong>：提供流畅的购物体验</li>
</ol>
<p>通过合理的架构设计和技术选型，可以构建稳定、高效、可扩展的电商系统。</p>
</div></div></div></article></div></main></div><script src="/_next/static/chunks/webpack-c81f7fd28659d64f.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/7b42d4e858e38c6b.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"2:I[2846,[],\"\"]\n5:I[4707,[],\"\"]\n8:I[6423,[],\"\"]\nb:I[1060,[],\"\"]\n6:[\"category\",\"notes\",\"d\"]\n7:[\"slug\",\"ecommerce-system-design\",\"d\"]\nc:[]\n0:[\"$\",\"$L2\",null,{\"buildId\":\"build\",\"assetPrefix\":\"\",\"urlParts\":[\"\",\"notes\",\"ecommerce-system-design\",\"\"],\"initialTree\":[\"\",{\"children\":[[\"category\",\"notes\",\"d\"],{\"children\":[[\"slug\",\"ecommerce-system-design\",\"d\"],{\"children\":[\"__PAGE__?{\\\"category\\\":\\\"notes\\\",\\\"slug\\\":\\\"ecommerce-system-design\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[[\"category\",\"notes\",\"d\"],{\"children\":[[\"slug\",\"ecommerce-system-design\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$L3\",\"$L4\",null],null],null]},[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"$6\",\"children\",\"$7\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"$6\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/7b42d4e858e38c6b.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],\"$L9\"],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$La\"],\"globalErrorComponent\":\"$b\",\"missingSlots\":\"$Wc\"}]\n"])</script><script>self.__next_f.push([1,"d:I[2972,[\"972\",\"static/chunks/972-81dbad6abe39d3fa.js\",\"832\",\"static/chunks/832-2b131d9fe9982edb.js\",\"621\",\"static/chunks/app/%5Bcategory%5D/%5Bslug%5D/page-eb51aa11033a73a2.js\"],\"\"]\ne:I[5546,[\"972\",\"static/chunks/972-81dbad6abe39d3fa.js\",\"832\",\"static/chunks/832-2b131d9fe9982edb.js\",\"621\",\"static/chunks/app/%5Bcategory%5D/%5Bslug%5D/page-eb51aa11033a73a2.js\"],\"default\"]\n10:I[7140,[\"972\",\"static/chunks/972-81dbad6abe39d3fa.js\",\"185\",\"static/chunks/app/layout-f3fa7e3100be56de.js\"],\"default\"]\nf:T6f90,"])</script><script>self.__next_f.push([1,"\n# 电商系统设计详解\n\n\u003e 电商系统是复杂业务系统的典型代表，其架构设计涵盖了多个技术领域\n\n## 电商系统概述\n\n### 1. 系统架构图\n\n```\n电商系统架构：\n┌─────────────────────────────────────────────────────────────┐\n│                    前端应用层                               │\n│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │\n│  │   Web       │ │   Mobile    │ │   Mini      │           │\n│  │   App       │ │   App       │ │   Program   │           │\n│  └─────────────┘  └─────────────┘  └─────────────┘           │\n└─────────────────────────────────────────────────────────────┘\n                          │\n                    ┌─────────────┐\n                    │  API        │\n                    │  Gateway    │\n                    └─────────────┘\n                          │\n          ┌───────────────┼───────────────┐\n          │               │               │\n    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐\n    │  User       │ │  Product    │ │  Order      │\n    │  Service    │ │  Service    │ │  Service    │\n    └─────────────┘ └─────────────┘ └─────────────┘\n          │               │               │\n          └───────────────┼───────────────┘\n                          │\n          ┌───────────────┼───────────────┐\n          │               │               │\n    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐\n    │  Payment    │ │  Search     │ │  Inventory  │\n    │  Service    │ │  Service    │ │  Service    │\n    └─────────────┘ └─────────────┘ └─────────────┘\n                          │\n          ┌───────────────┼───────────────┐\n          │               │               │\n    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐\n    │  MySQL      │ │  Redis      │ │  MQ         │\n    │  Cluster    │ │  Cluster    │ │  Cluster    │\n    └─────────────┘ └─────────────┘ └─────────────┘\n```\n\n### 2. 核心业务模块\n\n```\n核心业务模块：\n├── 用户中心\n│   ├── 用户注册登录\n│   ├── 用户信息管理\n│   ├── 地址管理\n│   └── 会员体系\n├── 商品中心\n│   ├── 商品管理\n│   ├── 分类管理\n│   ├── 品牌管理\n│   └── 库存管理\n├── 订单中心\n│   ├── 订单创建\n│   ├── 订单查询\n│   ├── 订单状态管理\n│   └── 订单统计\n├── 支付中心\n│   ├── 支付接口\n│   ├── 支付回调\n│   ├── 退款处理\n│   └── 对账管理\n├── 搜索中心\n│   ├── 商品搜索\n│   ├── 搜索推荐\n│   ├── 搜索统计\n│   └── 搜索优化\n└── 营销中心\n    ├── 优惠券\n    ├── 秒杀活动\n    ├── 拼团活动\n    └── 积分系统\n```\n\n## 用户中心设计\n\n### 1. 用户注册登录\n\n**用户服务实现**\n```java\n@Service\n@Transactional\npublic class UserService {\n    \n    @Autowired\n    private UserRepository userRepository;\n    \n    @Autowired\n    private PasswordEncoder passwordEncoder;\n    \n    @Autowired\n    private JwtAuthenticationService jwtService;\n    \n    @Autowired\n    private RedisTemplate\u003cString, String\u003e redisTemplate;\n    \n    // 用户注册\n    public User register(UserRegistrationRequest request) {\n        // 1. 验证用户名唯一性\n        if (userRepository.existsByUsername(request.getUsername())) {\n            throw new BusinessException(\"用户名已存在\");\n        }\n        \n        // 2. 验证邮箱唯一性\n        if (userRepository.existsByEmail(request.getEmail())) {\n            throw new BusinessException(\"邮箱已存在\");\n        }\n        \n        // 3. 验证手机号唯一性\n        if (userRepository.existsByPhone(request.getPhone())) {\n            throw new BusinessException(\"手机号已存在\");\n        }\n        \n        // 4. 创建用户\n        User user = new User();\n        user.setUsername(request.getUsername());\n        user.setEmail(request.getEmail());\n        user.setPhone(request.getPhone());\n        user.setPassword(passwordEncoder.encode(request.getPassword()));\n        user.setStatus(UserStatus.ACTIVE);\n        user.setCreateTime(new Date());\n        \n        return userRepository.save(user);\n    }\n    \n    // 用户登录\n    public LoginResponse login(LoginRequest request) {\n        // 1. 验证用户名密码\n        User user = userRepository.findByUsername(request.getUsername())\n            .orElseThrow(() -\u003e new BusinessException(\"用户名或密码错误\"));\n        \n        if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {\n            throw new BusinessException(\"用户名或密码错误\");\n        }\n        \n        // 2. 检查用户状态\n        if (user.getStatus() != UserStatus.ACTIVE) {\n            throw new BusinessException(\"用户账号已被禁用\");\n        }\n        \n        // 3. 生成JWT Token\n        String token = jwtService.generateToken(createUserDetails(user));\n        \n        // 4. 更新最后登录时间\n        user.setLastLoginTime(new Date());\n        userRepository.save(user);\n        \n        // 5. 记录登录日志\n        recordLoginLog(user.getId(), request.getIp());\n        \n        return new LoginResponse(token, user);\n    }\n    \n    // 发送验证码\n    public void sendVerificationCode(String phone) {\n        // 1. 生成验证码\n        String code = generateVerificationCode();\n        \n        // 2. 存储验证码（5分钟过期）\n        String key = \"verification:code:\" + phone;\n        redisTemplate.opsForValue().set(key, code, 5, TimeUnit.MINUTES);\n        \n        // 3. 发送短信\n        smsService.sendVerificationCode(phone, code);\n    }\n    \n    // 验证手机号\n    public boolean verifyPhone(String phone, String code) {\n        String key = \"verification:code:\" + phone;\n        String storedCode = redisTemplate.opsForValue().get(key);\n        \n        if (storedCode != null \u0026\u0026 storedCode.equals(code)) {\n            redisTemplate.delete(key);\n            return true;\n        }\n        \n        return false;\n    }\n    \n    private String generateVerificationCode() {\n        Random random = new Random();\n        return String.format(\"%06d\", random.nextInt(1000000));\n    }\n    \n    private UserDetails createUserDetails(User user) {\n        return org.springframework.security.core.userdetails.User.builder()\n            .username(user.getUsername())\n            .password(user.getPassword())\n            .authorities(\"ROLE_USER\")\n            .build();\n    }\n    \n    private void recordLoginLog(Long userId, String ip) {\n        LoginLog log = new LoginLog();\n        log.setUserId(userId);\n        log.setIp(ip);\n        log.setLoginTime(new Date());\n        loginLogRepository.save(log);\n    }\n}\n```\n\n### 2. 用户信息管理\n\n**用户信息更新**\n```java\n@RestController\n@RequestMapping(\"/api/users\")\npublic class UserController {\n    \n    @Autowired\n    private UserService userService;\n    \n    @PutMapping(\"/profile\")\n    public Result updateUserProfile(@RequestBody UserProfileRequest request,\n                                  @AuthenticationPrincipal UserDetails userDetails) {\n        Long userId = getCurrentUserId(userDetails);\n        \n        User user = userService.updateUserProfile(userId, request);\n        return Result.success(user);\n    }\n    \n    @PostMapping(\"/avatar\")\n    public Result uploadAvatar(@RequestParam(\"file\") MultipartFile file,\n                              @AuthenticationPrincipal UserDetails userDetails) {\n        Long userId = getCurrentUserId(userDetails);\n        \n        String avatarUrl = userService.uploadAvatar(userId, file);\n        return Result.success(avatarUrl);\n    }\n    \n    @GetMapping(\"/addresses\")\n    public Result\u003cList\u003cAddress\u003e\u003e getUserAddresses(@AuthenticationPrincipal UserDetails userDetails) {\n        Long userId = getCurrentUserId(userDetails);\n        \n        List\u003cAddress\u003e addresses = userService.getUserAddresses(userId);\n        return Result.success(addresses);\n    }\n    \n    @PostMapping(\"/addresses\")\n    public Result\u003cAddress\u003e addAddress(@RequestBody AddressRequest request,\n                                      @AuthenticationPrincipal UserDetails userDetails) {\n        Long userId = getCurrentUserId(userDetails);\n        \n        Address address = userService.addAddress(userId, request);\n        return Result.success(address);\n    }\n    \n    @PutMapping(\"/addresses/{addressId}\")\n    public Result\u003cAddress\u003e updateAddress(@PathVariable Long addressId,\n                                         @RequestBody AddressRequest request,\n                                         @AuthenticationPrincipal UserDetails userDetails) {\n        Long userId = getCurrentUserId(userDetails);\n        \n        Address address = userService.updateAddress(userId, addressId, request);\n        return Result.success(address);\n    }\n    \n    @DeleteMapping(\"/addresses/{addressId}\")\n    public Result deleteAddress(@PathVariable Long addressId,\n                                @AuthenticationPrincipal UserDetails userDetails) {\n        Long userId = getCurrentUserId(userDetails);\n        \n        userService.deleteAddress(userId, addressId);\n        return Result.success();\n    }\n}\n```\n\n## 商品中心设计\n\n### 1. 商品管理\n\n**商品服务实现**\n```java\n@Service\n@Transactional\npublic class ProductService {\n    \n    @Autowired\n    private ProductRepository productRepository;\n    \n    @Autowired\n    private CategoryService categoryService;\n    \n    @Autowired\n    private BrandService brandService;\n    \n    @Autowired\n    private InventoryService inventoryService;\n    \n    @Autowired\n    private SearchService searchService;\n    \n    // 创建商品\n    public Product createProduct(ProductCreateRequest request) {\n        // 1. 验证分类是否存在\n        Category category = categoryService.getCategory(request.getCategoryId());\n        if (category == null) {\n            throw new BusinessException(\"分类不存在\");\n        }\n        \n        // 2. 验证品牌是否存在\n        Brand brand = brandService.getBrand(request.getBrandId());\n        if (brand == null) {\n            throw new BusinessException(\"品牌不存在\");\n        }\n        \n        // 3. 创建商品\n        Product product = new Product();\n        product.setName(request.getName());\n        product.setDescription(request.getDescription());\n        product.setCategoryId(request.getCategoryId());\n        product.setBrandId(request.getBrandId());\n        product.setPrice(request.getPrice());\n        product.setOriginalPrice(request.getOriginalPrice());\n        product.setImages(request.getImages());\n        product.setAttributes(request.getAttributes());\n        product.setStatus(ProductStatus.ACTIVE);\n        product.setCreateTime(new Date());\n        \n        product = productRepository.save(product);\n        \n        // 4. 初始化库存\n        inventoryService.initInventory(product.getId(), request.getStock());\n        \n        // 5. 同步到搜索引擎\n        searchService.indexProduct(product);\n        \n        return product;\n    }\n    \n    // 更新商品\n    public Product updateProduct(Long productId, ProductUpdateRequest request) {\n        Product product = getProduct(productId);\n        \n        // 更新商品信息\n        if (request.getName() != null) {\n            product.setName(request.getName());\n        }\n        if (request.getDescription() != null) {\n            product.setDescription(request.getDescription());\n        }\n        if (request.getPrice() != null) {\n            product.setPrice(request.getPrice());\n        }\n        if (request.getImages() != null) {\n            product.setImages(request.getImages());\n        }\n        if (request.getAttributes() != null) {\n            product.setAttributes(request.getAttributes());\n        }\n        \n        product.setUpdateTime(new Date());\n        product = productRepository.save(product);\n        \n        // 同步到搜索引擎\n        searchService.updateProduct(product);\n        \n        return product;\n    }\n    \n    // 商品上下架\n    public void changeProductStatus(Long productId, ProductStatus status) {\n        Product product = getProduct(productId);\n        product.setStatus(status);\n        product.setUpdateTime(new Date());\n        productRepository.save(product);\n        \n        // 同步到搜索引擎\n        if (status == ProductStatus.ACTIVE) {\n            searchService.indexProduct(product);\n        } else {\n            searchService.deleteProduct(productId);\n        }\n    }\n    \n    // 获取商品详情\n    public Product getProductDetail(Long productId) {\n        Product product = getProduct(productId);\n        \n        // 获取库存信息\n        Integer stock = inventoryService.getStock(productId);\n        product.setStock(stock);\n        \n        return product;\n    }\n    \n    // 商品搜索\n    public Page\u003cProduct\u003e searchProducts(ProductSearchRequest request) {\n        return searchService.searchProducts(request);\n    }\n    \n    // 商品推荐\n    public List\u003cProduct\u003e recommendProducts(Long userId, int limit) {\n        return searchService.recommendProducts(userId, limit);\n    }\n    \n    private Product getProduct(Long productId) {\n        return productRepository.findById(productId)\n            .orElseThrow(() -\u003e new BusinessException(\"商品不存在\"));\n    }\n}\n```\n\n### 2. 分类管理\n\n**分类服务实现**\n```java\n@Service\n@Transactional\npublic class CategoryService {\n    \n    @Autowired\n    private CategoryRepository categoryRepository;\n    \n    @Autowired\n    private RedisTemplate\u003cString, String\u003e redisTemplate;\n    \n    // 创建分类\n    public Category createCategory(CategoryCreateRequest request) {\n        // 验证父分类是否存在\n        if (request.getParentId() != null) {\n            Category parent = getCategory(request.getParentId());\n            if (parent == null) {\n                throw new BusinessException(\"父分类不存在\");\n            }\n        }\n        \n        // 验证分类名称唯一性\n        if (categoryRepository.existsByNameAndParentId(request.getName(), request.getParentId())) {\n            throw new BusinessException(\"分类名称已存在\");\n        }\n        \n        Category category = new Category();\n        category.setName(request.getName());\n        category.setParentId(request.getParentId());\n        category.setLevel(request.getParentId() == null ? 1 : \n            getCategory(request.getParentId()).getLevel() + 1);\n        category.setSort(request.getSort());\n        category.setIcon(request.getIcon());\n        category.setStatus(CategoryStatus.ACTIVE);\n        category.setCreateTime(new Date());\n        \n        category = categoryRepository.save(category);\n        \n        // 清除缓存\n        clearCategoryCache();\n        \n        return category;\n    }\n    \n    // 获取分类树\n    public List\u003cCategoryTree\u003e getCategoryTree() {\n        String cacheKey = \"category:tree\";\n        String cached = redisTemplate.opsForValue().get(cacheKey);\n        \n        if (cached != null) {\n            return JSON.parseArray(cached, CategoryTree.class);\n        }\n        \n        List\u003cCategory\u003e allCategories = categoryRepository.findAllByStatus(CategoryStatus.ACTIVE);\n        List\u003cCategoryTree\u003e tree = buildCategoryTree(allCategories, 0L);\n        \n        // 缓存结果\n        redisTemplate.opsForValue().set(cacheKey, JSON.toJSONString(tree), 1, TimeUnit.HOURS);\n        \n        return tree;\n    }\n    \n    // 获取子分类\n    public List\u003cCategory\u003e getChildCategories(Long parentId) {\n        return categoryRepository.findByParentIdAndStatus(parentId, CategoryStatus.ACTIVE);\n    }\n    \n    // 获取分类路径\n    public List\u003cCategory\u003e getCategoryPath(Long categoryId) {\n        List\u003cCategory\u003e path = new ArrayList\u003c\u003e();\n        Category category = getCategory(categoryId);\n        \n        while (category != null) {\n            path.add(0, category);\n            category = category.getParentId() != null ? \n                getCategory(category.getParentId()) : null;\n        }\n        \n        return path;\n    }\n    \n    private List\u003cCategoryTree\u003e buildCategoryTree(List\u003cCategory\u003e categories, Long parentId) {\n        List\u003cCategoryTree\u003e tree = new ArrayList\u003c\u003e();\n        \n        for (Category category : categories) {\n            if (Objects.equals(category.getParentId(), parentId)) {\n                CategoryTree node = new CategoryTree();\n                node.setId(category.getId());\n                node.setName(category.getName());\n                node.setIcon(category.getIcon());\n                node.setChildren(buildCategoryTree(categories, category.getId()));\n                tree.add(node);\n            }\n        }\n        \n        return tree;\n    }\n    \n    private void clearCategoryCache() {\n        redisTemplate.delete(\"category:tree\");\n    }\n    \n    public Category getCategory(Long categoryId) {\n        if (categoryId == null) {\n            return null;\n        }\n        return categoryRepository.findById(categoryId).orElse(null);\n    }\n}\n```\n\n## 订单中心设计\n\n### 1. 订单创建\n\n**订单服务实现**\n```java\n@Service\n@Transactional\npublic class OrderService {\n    \n    @Autowired\n    private OrderRepository orderRepository;\n    \n    @Autowired\n    private OrderItemRepository orderItemRepository;\n    \n    @Autowired\n    private ProductService productService;\n    \n    @Autowired\n    private InventoryService inventoryService;\n    \n    @Autowired\n    private CartService cartService;\n    \n    @Autowired\n    private PaymentService paymentService;\n    \n    @Autowired\n    private RabbitTemplate rabbitTemplate;\n    \n    // 创建订单\n    public Order createOrder(OrderCreateRequest request, Long userId) {\n        // 1. 验证商品信息\n        List\u003cOrderItem\u003e orderItems = validateOrderItems(request.getItems());\n        \n        // 2. 计算订单金额\n        OrderAmount amount = calculateOrderAmount(orderItems, request.getCouponId());\n        \n        // 3. 检查库存\n        checkInventory(orderItems);\n        \n        // 4. 创建订单\n        Order order = new Order();\n        order.setOrderNo(generateOrderNo());\n        order.setUserId(userId);\n        order.setStatus(OrderStatus.PENDING_PAYMENT);\n        order.setTotalAmount(amount.getTotalAmount());\n        order.setDiscountAmount(amount.getDiscountAmount());\n        order.setPayAmount(amount.getPayAmount());\n        order.setShippingAddress(request.getShippingAddress());\n        order.setRemark(request.getRemark());\n        order.setCreateTime(new Date());\n        \n        order = orderRepository.save(order);\n        \n        // 5. 创建订单项\n        for (OrderItem item : orderItems) {\n            item.setOrderId(order.getId());\n            orderItemRepository.save(item);\n        }\n        \n        // 6. 锁定库存\n        inventoryService.lockInventory(orderItems, order.getOrderNo());\n        \n        // 7. 清空购物车\n        cartService.clearCart(userId, request.getItemIds());\n        \n        // 8. 发送订单创建消息\n        sendOrderCreatedMessage(order);\n        \n        return order;\n    }\n    \n    // 订单支付\n    public PaymentResponse payOrder(Long orderId, PaymentRequest request) {\n        Order order = getOrder(orderId);\n        \n        // 验证订单状态\n        if (order.getStatus() != OrderStatus.PENDING_PAYMENT) {\n            throw new BusinessException(\"订单状态不正确\");\n        }\n        \n        // 创建支付\n        Payment payment = paymentService.createPayment(order, request);\n        \n        return new PaymentResponse(payment.getPaymentNo(), payment.getPayUrl());\n    }\n    \n    // 订单支付成功\n    public void handlePaymentSuccess(String paymentNo) {\n        Payment payment = paymentService.getPaymentByNo(paymentNo);\n        Order order = getOrder(payment.getOrderId());\n        \n        // 更新订单状态\n        order.setStatus(OrderStatus.PAID);\n        order.setPayTime(new Date());\n        orderRepository.save(order);\n        \n        // 扣减库存\n        inventoryService.deductInventory(payment.getOrderId());\n        \n        // 发送支付成功消息\n        sendPaymentSuccessMessage(order);\n    }\n    \n    // 订单发货\n    public void shipOrder(Long orderId, ShipOrderRequest request) {\n        Order order = getOrder(orderId);\n        \n        // 验证订单状态\n        if (order.getStatus() != OrderStatus.PAID) {\n            throw new BusinessException(\"订单状态不正确\");\n        }\n        \n        // 更新订单状态\n        order.setStatus(OrderStatus.SHIPPED);\n        order.setShippingCompany(request.getShippingCompany());\n        order.setShippingNo(request.getShippingNo());\n        order.setShippingTime(new Date());\n        orderRepository.save(order);\n        \n        // 发送发货消息\n        sendOrderShippedMessage(order);\n    }\n    \n    // 确认收货\n    public void confirmReceipt(Long orderId) {\n        Order order = getOrder(orderId);\n        \n        // 验证订单状态\n        if (order.getStatus() != OrderStatus.SHIPPED) {\n            throw new BusinessException(\"订单状态不正确\");\n        }\n        \n        // 更新订单状态\n        order.setStatus(OrderStatus.COMPLETED);\n        order.setConfirmTime(new Date());\n        orderRepository.save(order);\n        \n        // 发送确认收货消息\n        sendOrderCompletedMessage(order);\n    }\n    \n    // 取消订单\n    public void cancelOrder(Long orderId, String reason) {\n        Order order = getOrder(orderId);\n        \n        // 验证订单状态\n        if (order.getStatus() != OrderStatus.PENDING_PAYMENT) {\n            throw new BusinessException(\"订单状态不正确\");\n        }\n        \n        // 更新订单状态\n        order.setStatus(OrderStatus.CANCELLED);\n        order.setCancelReason(reason);\n        order.setCancelTime(new Date());\n        orderRepository.save(order);\n        \n        // 释放库存\n        inventoryService.releaseInventory(orderId);\n        \n        // 发送订单取消消息\n        sendOrderCancelledMessage(order);\n    }\n    \n    private List\u003cOrderItem\u003e validateOrderItems(List\u003cOrderItemRequest\u003e items) {\n        List\u003cOrderItem\u003e orderItems = new ArrayList\u003c\u003e();\n        \n        for (OrderItemRequest item : items) {\n            Product product = productService.getProductDetail(item.getProductId());\n            \n            // 验证商品状态\n            if (product.getStatus() != ProductStatus.ACTIVE) {\n                throw new BusinessException(\"商品已下架\");\n            }\n            \n            // 验证库存\n            if (product.getStock() \u003c item.getQuantity()) {\n                throw new BusinessException(\"商品库存不足\");\n            }\n            \n            OrderItem orderItem = new OrderItem();\n            orderItem.setProductId(product.getId());\n            orderItem.setProductName(product.getName());\n            orderItem.setProductImage(product.getImages().get(0));\n            orderItem.setPrice(product.getPrice());\n            orderItem.setQuantity(item.getQuantity());\n            orderItem.setTotalAmount(product.getPrice() * item.getQuantity());\n            \n            orderItems.add(orderItem);\n        }\n        \n        return orderItems;\n    }\n    \n    private OrderAmount calculateOrderAmount(List\u003cOrderItem\u003e orderItems, Long couponId) {\n        BigDecimal totalAmount = orderItems.stream()\n            .map(OrderItem::getTotalAmount)\n            .reduce(BigDecimal.ZERO, BigDecimal::add);\n        \n        BigDecimal discountAmount = BigDecimal.ZERO;\n        \n        // 计算优惠券折扣\n        if (couponId != null) {\n            discountAmount = couponService.calculateDiscount(couponId, totalAmount);\n        }\n        \n        BigDecimal payAmount = totalAmount.subtract(discountAmount);\n        \n        return new OrderAmount(totalAmount, discountAmount, payAmount);\n    }\n    \n    private void checkInventory(List\u003cOrderItem\u003e orderItems) {\n        for (OrderItem item : orderItems) {\n            Integer stock = inventoryService.getStock(item.getProductId());\n            if (stock \u003c item.getQuantity()) {\n                throw new BusinessException(\"商品库存不足\");\n            }\n        }\n    }\n    \n    private String generateOrderNo() {\n        return \"ORD\" + System.currentTimeMillis() + \n               String.format(\"%04d\", new Random().nextInt(10000));\n    }\n    \n    private void sendOrderCreatedMessage(Order order) {\n        OrderMessage message = new OrderMessage();\n        message.setOrderId(order.getId());\n        message.setOrderNo(order.getOrderNo());\n        message.setUserId(order.getUserId());\n        message.setAction(\"ORDER_CREATED\");\n        \n        rabbitTemplate.convertAndSend(\"order.exchange\", \"order.created\", message);\n    }\n    \n    private void sendPaymentSuccessMessage(Order order) {\n        OrderMessage message = new OrderMessage();\n        message.setOrderId(order.getId());\n        message.setOrderNo(order.getOrderNo());\n        message.setUserId(order.getUserId());\n        message.setAction(\"PAYMENT_SUCCESS\");\n        \n        rabbitTemplate.convertAndSend(\"order.exchange\", \"payment.success\", message);\n    }\n    \n    private void sendOrderShippedMessage(Order order) {\n        OrderMessage message = new OrderMessage();\n        message.setOrderId(order.getId());\n        message.setOrderNo(order.getOrderNo());\n        message.setUserId(order.getUserId());\n        message.setAction(\"ORDER_SHIPPED\");\n        \n        rabbitTemplate.convertAndSend(\"order.exchange\", \"order.shipped\", message);\n    }\n    \n    private void sendOrderCompletedMessage(Order order) {\n        OrderMessage message = new OrderMessage();\n        message.setOrderId(order.getId());\n        message.setOrderNo(order.getOrderNo());\n        message.setUserId(order.getUserId());\n        message.setAction(\"ORDER_COMPLETED\");\n        \n        rabbitTemplate.convertAndSend(\"order.exchange\", \"order.completed\", message);\n    }\n    \n    private void sendOrderCancelledMessage(Order order) {\n        OrderMessage message = new OrderMessage();\n        message.setOrderId(order.getId());\n        message.setOrderNo(order.getOrderNo());\n        message.setUserId(order.getUserId());\n        message.setAction(\"ORDER_CANCELLED\");\n        \n        rabbitTemplate.convertAndSend(\"order.exchange\", \"order.cancelled\", message);\n    }\n    \n    private Order getOrder(Long orderId) {\n        return orderRepository.findById(orderId)\n            .orElseThrow(() -\u003e new BusinessException(\"订单不存在\"));\n    }\n}\n```\n\n## 总结\n\n电商系统设计是一个复杂的工程，需要考虑：\n\n1. **业务复杂性**：涵盖用户、商品、订单、支付等多个业务域\n2. **高并发性**：需要支持大量用户同时访问\n3. **数据一致性**：保证订单、库存等数据的一致性\n4. **系统扩展性**：支持业务快速发展和扩展\n5. **用户体验**：提供流畅的购物体验\n\n通过合理的架构设计和技术选型，可以构建稳定、高效、可扩展的电商系统。"])</script><script>self.__next_f.push([1,"4:[\"$\",\"div\",null,{\"children\":[[\"$\",\"$Ld\",null,{\"href\":\"/notes\",\"className\":\"back-button\",\"style\":{\"display\":\"inline-block\",\"background\":\"var(--primary-color)\",\"color\":\"white\",\"border\":\"none\",\"padding\":\"10px 20px\",\"borderRadius\":\"6px\",\"cursor\":\"pointer\",\"marginBottom\":\"20px\",\"textDecoration\":\"none\"},\"children\":[\"← 返回\",\"笔记\",\"列表\"]}],[\"$\",\"article\",null,{\"className\":\"section\",\"children\":[[\"$\",\"header\",null,{\"className\":\"article-header\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"article-title\",\"children\":\"电商系统设计详解\"}],[\"$\",\"div\",null,{\"className\":\"article-meta\",\"children\":[\"$\",\"div\",null,{\"className\":\"article-tags\",\"children\":[[\"$\",\"span\",\"电商系统\",{\"className\":\"tag\",\"children\":\"电商系统\"}],[\"$\",\"span\",\"系统设计\",{\"className\":\"tag\",\"children\":\"系统设计\"}],[\"$\",\"span\",\"架构设计\",{\"className\":\"tag\",\"children\":\"架构设计\"}],[\"$\",\"span\",\"微服务\",{\"className\":\"tag\",\"children\":\"微服务\"}],[\"$\",\"span\",\"高并发\",{\"className\":\"tag\",\"children\":\"高并发\"}]]}]}]]}],[\"$\",\"div\",null,{\"className\":\"card markdown-content\",\"children\":[\"$\",\"$Le\",null,{\"content\":\"$f\"}]}]]}]]}]\n"])</script><script>self.__next_f.push([1,"9:[\"$\",\"html\",null,{\"lang\":\"zh-CN\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css\"}],[\"$\",\"script\",null,{\"src\":\"https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js\",\"async\":true}],[\"$\",\"script\",null,{\"src\":\"https://unpkg.com/markmap-autoloader@0.17.2\"}]]}],[\"$\",\"body\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"app\",\"children\":[[\"$\",\"$L10\",null,{\"siteConfig\":{\"name\":\"海元\",\"bio\":\"JAVA | AI | WEB3\",\"social\":[{\"name\":\"github\",\"icon\":\"fab fa-github\",\"url\":\"https://github.com/suogongy\"},{\"name\":\"twitter\",\"icon\":\"fab fa-twitter\",\"url\":\"https://twitter.com/suogongy\"},{\"name\":\"email\",\"icon\":\"fas fa-envelope\",\"url\":\"mailto:haiyuan1832@163.com\"}]}}],[\"$\",\"main\",null,{\"className\":\"main-content\",\"children\":[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[]}]}]]}]}]]}]\n"])</script><script>self.__next_f.push([1,"a:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"电商系统设计详解 - Personal GitHub Page\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"深入分析电商系统的整体架构设计，包括用户管理、商品管理、订单管理、支付系统、搜索系统等核心模块的设计思路和实现方案。\"}]]\n3:null\n"])</script></body></html>